{% extends "base.html" %}

{% block title %}Manage Users{% endblock %}


{% block content %}
<div class="container mt-3">
    <h2>User List</h2>
    <div class="d-flex justify-content-between align-items-center mb-3">
        <a href="{{ url_for('admin.add_user') }}" class="btn btn-primary">Add New User</a>

        <div class="d-flex">
            <!-- Filter Form -->
            <form class="form-inline mr-3" method="GET" action="{{ url_for('admin.manage_users') }}">
                <div class="form-group">
                    <label for="branch_id" class="mr-2">Filter:</label>
                    <select name="branch_id" id="branch_id" class="form-control" onchange="this.form.submit()">
                        <option value="0">All Branches</option>
                        {% for branch in branches %}
                        <option value="{{ branch.branch_id }}" {% if selected_branch_id==branch.branch_id %}selected{%
                            endif %}>{{ branch.branch_name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </form>

            <!-- Bulk Action Form Trigger (part of the main form below, this is just visual if we want, or we put actions inside the main form) -->
            <!-- Better approach: One big form for the bulk action, filter form separate -->
        </div>
    </div>

    <!-- Bulk Update Form -->
    <form action="{{ url_for('admin.bulk_update_users') }}" method="POST" id="bulkForm">
        <div class="card bg-light mb-3">
            <div class="card-body py-2">
                <div class="form-inline">
                    <label class="mr-2"><strong>Bulk Actions:</strong></label>
                    <select name="new_usertype_id" class="form-control mr-2" required>
                        <option value="">Select New User Type...</option>
                        {% for ut in usertypes %}
                        <option value="{{ ut.id }}">{{ ut.name }}</option>
                        {% endfor %}
                    </select>
                    <button type="submit" class="btn btn-warning"
                        onclick="return confirm('Are you sure you want to update the selected users?');">Update
                        Type</button>
                    <span class="text-muted ml-3"><small>(Select users below)</small></span>
                </div>
            </div>
        </div>

        <table class="table" id="usersTable">
            <thead>
                <tr>
                    <th style="width: 30px;"><input type="checkbox" id="selectAll"></th>
                    <th>ID</th>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Type</th>
                    <th>Branch</th>
                    <th>Estimator?</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td><input type="checkbox" name="user_ids" value="{{ user.id }}" class="user-checkbox"></td>
                    <td>{{ user.id }}</td>
                    <td>{{ user.username }}</td>
                    <td>{{ user.email }}</td>
                    <td>{{ user.usertype.name }}</td>
                    <td>{{ user.branch.branch_name if user.branch else 'N/A' }}</td>
                    <td>{% if user.is_estimator %}<span class="badge badge-success">Yes</span>{% else %}<span
                            class="badge badge-secondary">No</span>{% endif %}</td>
                    <td>
                        <a href="{{ url_for('admin.edit_user', user_id=user.id) }}"
                            class="btn btn-sm btn-warning">Edit</a>
                        <!-- Separate Delete Form needs to be carefully handled if inside another form. HTML forbids nesting forms.
                             We should use JS to submit delete, or move delete button outside, or keep delete forms separate and close the bulk form before the table? 
                             No, the checkboxes MUST be inside the bulk form.
                             So the Delete buttons cannot be separate <form>s inside the table. 
                             Solution: Use a link/button that triggers JS to post to delete endpoint, OR use querySelector to submit a hidden delete form.
                        -->
                        <button type="button" class="btn btn-sm btn-danger"
                            onclick="deleteUser({{ user.id }})">Delete</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </form>

    <!-- Hidden Delete Form Template -->
    <form id="deleteForm" method="POST" action="" style="display:none;">
    </form>

    <a href="{{ url_for('admin.user_type') }}" class="btn btn-secondary mt-3">Manage User Types</a>
    <a href="{{ url_for('main.index') }}" class="btn btn-secondary mt-3">Back to Home</a>

    <form action="{{ url_for('admin.upload_users') }}" method="post" enctype="multipart/form-data">
        <input type="file" name="file" accept=".csv">
        <input type="submit" value="Upload">
    </form>

</div>
{% endblock %}

{% block scripts %}
<script>
    function deleteUser(userId) {
        if (confirm('Are you sure you want to delete this user?')) {
            var form = document.getElementById('deleteForm');
            form.action = "{{ url_for('admin.delete_user', user_id=0) }}".replace('0', userId);
            form.submit();
        }
    }

    $(document).ready(function () {
        var table = $('#usersTable').DataTable({
            responsive: true,
            "pageLength": 50,
            "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
            "columnDefs": [{ "orderable": false, "targets": 0 }],
            "order": [[1, "asc"]] // Sort by ID by default
        });

        // Handle Select All (works across pages if we want, but simple 'all on page' is easier for now)
        $('#selectAll').on('click', function () {
            var rows = table.rows({ 'search': 'applied' }).nodes();
            $('input[type="checkbox"]', rows).prop('checked', this.checked);
        });
    });
</script>
{% endblock %}