{% extends "base.html" %}

{% block title %}Manage Bid | Beisser.io{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="premium-card">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="m-0 font-weight-bold" style="font-family: 'Outfit', sans-serif;">Manage Bid</h2>
                <div>
                    <a href="{{ url_for('main.download_spec_sheet', bid_id=bid.id) }}"
                        class="btn btn-sm btn-outline-primary mr-2" target="_blank">
                        <i class="fas fa-file-pdf mr-1"></i> Download Spec Sheet
                    </a>
                    <a href="{{ url_for('main.open_bids') }}" class="btn text-muted font-weight-600 small">
                        <i class="fas fa-arrow-left mr-2"></i> Back to Open Bids
                    </a>
                </div>
            </div>

            {% set is_readonly = (current_user.usertype.name == 'Sales Rep') %}

            <form action="{{ url_for('main.manage_bid', bid_id=bid.id) }}" method="POST">
                <fieldset {% if is_readonly %}disabled{% endif %}>
                    {{ form.hidden_tag() }}

                    {# Render CSRF tokens for nested subforms REMOVED as subforms are gone #}

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="font-weight-600 small text-uppercase tracking-wider">Plan Type</label>
                                {{ form.plan_type(class="input-modern") }}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="font-weight-600 small text-uppercase tracking-wider">Customer</label>
                                {{ form.customer_id(class="input-modern") }}
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="font-weight-600 small text-uppercase tracking-wider">Project Name</label>
                        {{ form.project_name(class="input-modern") }}
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="font-weight-600 small text-uppercase tracking-wider">Estimator</label>
                                {{ form.estimator_id(class="input-modern") }}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="font-weight-600 small text-uppercase tracking-wider">Status</label>
                                {% if current_user.usertype.name == 'Sales Rep' %}
                                <input type="text" class="input-modern" value="{{ bid.status }}" disabled>
                                <!-- Hidden field to submit the value, though Reps usually can't save changes to this anyway -->
                                {% else %}
                                {{ form.status(class="input-modern") }}
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label class="font-weight-600 small text-uppercase tracking-wider">Sales Rep</label>
                                {% if current_user.usertype.name == 'Sales Rep' %}
                                <!-- Read-only for Sales Reps -->
                                {{ form.sales_rep_id(class="input-modern", disabled=True) }}
                                {% else %}
                                {{ form.sales_rep_id(class="input-modern") }}
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="font-weight-600 small text-uppercase tracking-wider">Bid Date <span
                                        class="text-muted font-weight-normal">(Optional)</span></label>
                                {{ form.bid_date(class="input-modern", type="date") }}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="font-weight-600 small text-uppercase tracking-wider">Due Date</label>
                                {{ form.due_date(class="input-modern", type="date") }}
                            </div>
                        </div>
                    </div>

                    <!-- Flexible Bid Date Toggle - Visible only when Bid Date is set -->
                    <div class="form-group mb-4" id="flexible-date-container" style="display: none;">
                        <div class="custom-control custom-checkbox">
                            {{ form.flexible_bid_date(class="custom-control-input", id="flexibleBidDate") }}
                            <label class="custom-control-label font-weight-600 text-muted" for="flexibleBidDate">
                                {{ form.flexible_bid_date.label.text }}
                            </label>
                        </div>
                    </div>

                    <!-- Attachments Display -->
                    <div class="mt-4 mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <label class="font-weight-600 small text-uppercase tracking-wider m-0">Attachments</label>
                            {% if bid.plan_filename or bid.email_filename or bid.files|length > 0 %}
                            <a href="{{ url_for('main.download_all_bid_files', bid_id=bid.id) }}"
                                class="btn btn-primary btn-sm">
                                <i class="fas fa-download mr-2"></i> Download All
                            </a>
                            {% endif %}
                        </div>
                        <div class="d-flex flex-wrap gap-3">
                            {% if bid.plan_filename %}
                            <a href="{{ url_for('main.download_bid_file', bid_id=bid.id, file_type='plan') }}"
                                target="_blank" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-file-pdf mr-2"></i> Download Plan
                            </a>
                            {% else %}
                            <span class="text-muted small border rounded px-3 py-2">No Plan Attached</span>
                            {% endif %}

                            {% if bid.email_filename %}
                            <a href="{{ url_for('main.download_bid_file', bid_id=bid.id, file_type='email') }}"
                                target="_blank" class="btn btn-outline-secondary btn-sm">
                                <i class="fas fa-envelope mr-2"></i> Download Email/Doc
                            </a>
                            {% else %}
                            <span class="text-muted small border rounded px-3 py-2">No Email Attached</span>
                            {% endif %}

                            <!-- List Additional Files -->
                            {% for file in bid.files %}
                            <a href="{{ get_s3_url(file.file_key) }}" target="_blank"
                                class="btn btn-outline-info btn-sm">
                                <i class="fas fa-file-alt mr-2"></i> {{ file.filename }}
                            </a>
                            {% endfor %}
                        </div>

                        <!-- Add New Files -->
                        <div class="mt-4 pt-3 border-top">
                            <label class="font-weight-600 small text-uppercase tracking-wider mb-2">Upload Additional
                                Files</label>
                            <input type="file" id="file_multi" class="form-control-file" multiple>
                            <input type="hidden" name="bid_files_json" id="bid_files_json">
                            <div id="multi-file-list" class="mt-2"></div>
                        </div>
                    </div>

                    <!-- Specs Toggle Removed -->

                    <!-- Full Width Section: Module Notes (Hidden by default) -->
                    <div class="col-12 mt-3 pt-3 border-top" id="specs-section">
                        <h5 class="mb-4 text-primary d-flex align-items-center"
                            style="font-size: 1rem; letter-spacing: 0.5px;">
                            <i class="fas fa-list-alt mr-2 small"></i> MODULE SPECIFICATIONS
                        </h5>

                        <!-- Section Toggles -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <label class="font-weight-600 small text-uppercase tracking-wider mb-2">Select Sections
                                    to Include:</label>
                                <div class="d-flex flex-wrap gap-3">
                                    <div class="custom-control custom-checkbox mr-3 mb-2">
                                        {{ form.include_framing(class="custom-control-input section-toggle",
                                        id="toggle_framing") }}
                                        <label class="custom-control-label" for="toggle_framing">Framing</label>
                                    </div>
                                    <div class="custom-control custom-checkbox mr-3 mb-2">
                                        {{ form.include_siding(class="custom-control-input section-toggle",
                                        id="toggle_siding") }}
                                        <label class="custom-control-label" for="toggle_siding">Siding</label>
                                    </div>
                                    <div class="custom-control custom-checkbox mr-3 mb-2">
                                        {{ form.include_shingle(class="custom-control-input section-toggle",
                                        id="toggle_shingle") }}
                                        <label class="custom-control-label" for="toggle_shingle">Shingles</label>
                                    </div>
                                    <div class="custom-control custom-checkbox mr-3 mb-2">
                                        {{ form.include_deck(class="custom-control-input section-toggle",
                                        id="toggle_deck") }}
                                        <label class="custom-control-label" for="toggle_deck">Deck</label>
                                    </div>
                                    <div class="custom-control custom-checkbox mr-3 mb-2">
                                        {{ form.include_trim(class="custom-control-input section-toggle",
                                        id="toggle_trim") }}
                                        <label class="custom-control-label" for="toggle_trim">Trim</label>
                                    </div>
                                    <div class="custom-control custom-checkbox mr-3 mb-2">
                                        {{ form.include_window(class="custom-control-input section-toggle",
                                        id="toggle_window") }}
                                        <label class="custom-control-label" for="toggle_window">Window</label>
                                    </div>
                                    <div class="custom-control custom-checkbox mr-3 mb-2">
                                        {{ form.include_door(class="custom-control-input section-toggle",
                                        id="toggle_door") }}
                                        <label class="custom-control-label" for="toggle_door">Door</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Framing Section (Full Width) -->
                        <div class="row" id="section-framing" style="display:none;">
                            <div class="col-12">
                                <div class="card mb-4 shadow-sm">
                                    <div class="card-header bg-light py-2">
                                        <h6 class="mb-0 text-primary font-weight-bold"><i
                                                class="fas fa-hammer mr-2"></i> Framing</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            {# Legacy fields removed #}
                                            {# --- DYNAMIC FRAMING FIELDS --- #}
                                            {% for field in dynamic_fields %}
                                            {% if field.category == 'Framing' %}
                                            <div class="col-md-4 mb-3">
                                                <label class="font-weight-600 small text-uppercase text-muted mb-1">
                                                    {{ field.name }}
                                                    {% if field.is_required %}<span class="text-danger">*</span>{% endif
                                                    %}
                                                </label>

                                                {% set existing_val = dynamic_values_map.get(field.id|string, '') %}

                                                {% if field.field_type == 'select' %}
                                                <select name="dynamic_field_{{ field.id }}"
                                                    class="form-control form-control-sm" {% if field.is_required
                                                    %}required{% endif %}>
                                                    <option value="">Select {{ field.name }}</option>
                                                    {% set options = field.options|from_json_safe %}
                                                    {% for opt in options %}
                                                    <option value="{{ opt }}" {% if opt==existing_val %}selected{% endif
                                                        %}>{{ opt }}</option>
                                                    {% endfor %}
                                                </select>
                                                {% elif field.field_type == 'textarea' %}
                                                <textarea name="dynamic_field_{{ field.id }}"
                                                    class="form-control form-control-sm" rows="2" {% if
                                                    field.is_required %}required{% endif
                                                    %}>{{ existing_val }}</textarea>
                                                {% else %}
                                                <input type="text" name="dynamic_field_{{ field.id }}"
                                                    class="form-control form-control-sm" value="{{ existing_val }}" {%
                                                    if field.is_required %}required{% endif %}>
                                                {% endif %}
                                            </div>
                                            {% endif %}
                                            {% endfor %}

                                            <!-- Additional Notes for Framing -->
                                            <div class="col-12 mt-2">
                                                <label class="font-weight-600 small text-uppercase text-muted mb-1">{{
                                                    form.framing_notes.label.text }}</label>
                                                {{ form.framing_notes(class="form-control form-control-sm", rows="2") }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Siding Section (Full Width) -->
                        <div class="row" id="section-siding" style="display:none;">
                            <div class="col-12">
                                <div class="card mb-4 shadow-sm">
                                    <div class="card-header bg-light py-2">
                                        <h6 class="mb-0 text-info font-weight-bold"><i
                                                class="fas fa-layer-group mr-2"></i> Siding</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            {# Legacy fields removed #}
                                            {# --- DYNAMIC SIDING FIELDS --- #}
                                            {% for field in dynamic_fields %}
                                            {% if field.category == 'Siding' %}
                                            <div class="col-md-4 mb-3">
                                                <label class="font-weight-600 small text-uppercase text-muted mb-1">
                                                    {{ field.name }}
                                                    {% if field.is_required %}<span class="text-danger">*</span>{% endif
                                                    %}
                                                </label>

                                                {% set existing_val = dynamic_values_map.get(field.id|string, '') %}

                                                {% if field.field_type == 'select' %}
                                                <select name="dynamic_field_{{ field.id }}"
                                                    class="form-control form-control-sm" {% if field.is_required
                                                    %}required{% endif %}>
                                                    <option value="">Select {{ field.name }}</option>
                                                    {% set options = field.options|from_json_safe %}
                                                    {% for opt in options %}
                                                    <option value="{{ opt }}" {% if opt==existing_val %}selected{% endif
                                                        %}>{{ opt }}</option>
                                                    {% endfor %}
                                                </select>
                                                {% elif field.field_type == 'textarea' %}
                                                <textarea name="dynamic_field_{{ field.id }}"
                                                    class="form-control form-control-sm" rows="2" {% if
                                                    field.is_required %}required{% endif
                                                    %}>{{ existing_val }}</textarea>
                                                {% else %}
                                                <input type="text" name="dynamic_field_{{ field.id }}"
                                                    class="form-control form-control-sm" value="{{ existing_val }}" {%
                                                    if field.is_required %}required{% endif %}>
                                                {% endif %}
                                            </div>
                                            {% endif %}
                                            {% endfor %}
                                            <div class="col-12 mt-2">
                                                <label class="font-weight-600 small text-uppercase text-muted mb-1">{{
                                                    form.siding_notes.label.text }}</label>
                                                {{ form.siding_notes(class="form-control form-control-sm", rows="2") }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Shingle/Roof Section (Full Width) -->
                        <div class="row" id="section-shingle" style="display:none;">
                            <div class="col-12">
                                <div class="card mb-4 shadow-sm">
                                    <div class="card-header bg-light py-2">
                                        <h6 class="mb-0 text-secondary font-weight-bold"><i
                                                class="fas fa-home mr-2"></i> Shingle/Roof</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            {# Legacy fields removed #}
                                            {# --- DYNAMIC SHINGLE FIELDS --- #}
                                            {% for field in dynamic_fields %}
                                            {% if field.category == 'Shingles' %}
                                            <div class="col-md-12 mb-2">
                                                <label class="font-weight-600 small text-uppercase text-muted mb-1">
                                                    {{ field.name }}
                                                    {% if field.is_required %}<span class="text-danger">*</span>{% endif
                                                    %}
                                                </label>

                                                {% set existing_val = dynamic_values_map.get(field.id|string, '') %}

                                                {% if field.field_type == 'select' %}
                                                <select name="dynamic_field_{{ field.id }}"
                                                    class="form-control form-control-sm" {% if field.is_required
                                                    %}required{% endif %}>
                                                    <option value="">Select {{ field.name }}</option>
                                                    {% set options = field.options|from_json_safe %}
                                                    {% for opt in options %}
                                                    <option value="{{ opt }}" {% if opt==existing_val %}selected{% endif
                                                        %}>{{ opt }}</option>
                                                    {% endfor %}
                                                </select>
                                                {% elif field.field_type == 'textarea' %}
                                                <textarea name="dynamic_field_{{ field.id }}"
                                                    class="form-control form-control-sm" rows="2" {% if
                                                    field.is_required %}required{% endif
                                                    %}>{{ existing_val }}</textarea>
                                                {% else %}
                                                <input type="text" name="dynamic_field_{{ field.id }}"
                                                    class="form-control form-control-sm" value="{{ existing_val }}" {%
                                                    if field.is_required %}required{% endif %}>
                                                {% endif %}
                                            </div>
                                            {% endif %}
                                            {% endfor %}
                                            <div class="col-12 mt-2">
                                                <label class="font-weight-600 small text-uppercase text-muted mb-1">{{
                                                    form.shingle_notes.label.text }}</label>
                                                {{ form.shingle_notes(class="form-control form-control-sm", rows="2") }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Deck Section (Full Width) -->
                        <div class="row" id="section-deck" style="display:none;">
                            <div class="col-12">
                                <div class="card mb-4 shadow-sm">
                                    <div class="card-header bg-light py-2">
                                        <h6 class="mb-0 text-success font-weight-bold"><i
                                                class="fas fa-umbrella mr-2"></i> Deck</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            {# Legacy fields removed #}
                                            {# --- DYNAMIC DECK FIELDS --- #}
                                            {% for field in dynamic_fields %}
                                            {% if field.category == 'Deck' %}
                                            <div class="col-md-4 mb-3">
                                                <label class="font-weight-600 small text-uppercase text-muted mb-1">
                                                    {{ field.name }}
                                                    {% if field.is_required %}<span class="text-danger">*</span>{% endif
                                                    %}
                                                </label>

                                                {% set existing_val = dynamic_values_map.get(field.id|string, '') %}

                                                {% if field.field_type == 'select' %}
                                                <select name="dynamic_field_{{ field.id }}"
                                                    class="form-control form-control-sm" {% if field.is_required
                                                    %}required{% endif %}>
                                                    <option value="">Select {{ field.name }}</option>
                                                    {% set options = field.options|from_json_safe %}
                                                    {% for opt in options %}
                                                    <option value="{{ opt }}" {% if opt==existing_val %}selected{% endif
                                                        %}>{{ opt }}</option>
                                                    {% endfor %}
                                                </select>
                                                {% elif field.field_type == 'textarea' %}
                                                <textarea name="dynamic_field_{{ field.id }}"
                                                    class="form-control form-control-sm" rows="2" {% if
                                                    field.is_required %}required{% endif
                                                    %}>{{ existing_val }}</textarea>
                                                {% else %}
                                                <input type="text" name="dynamic_field_{{ field.id }}"
                                                    class="form-control form-control-sm" value="{{ existing_val }}" {%
                                                    if field.is_required %}required{% endif %}>
                                                {% endif %}
                                            </div>
                                            {% endif %}
                                            {% endfor %}
                                            <div class="col-12 mt-2">
                                                <label class="font-weight-600 small text-uppercase text-muted mb-1">{{
                                                    form.deck_notes.label.text }}</label>
                                                {{ form.deck_notes(class="form-control form-control-sm", rows="2") }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Trim Section (Full Width) -->
                        <div class="row" id="section-trim" style="display:none;">
                            <div class="col-12">
                                <div class="card mb-4 shadow-sm">
                                    <div class="card-header bg-light py-2">
                                        <h6 class="mb-0 text-warning font-weight-bold"><i
                                                class="fas fa-ruler-combined mr-2"></i> Trim</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            {# Legacy fields removed #}
                                            {# --- DYNAMIC TRIM FIELDS --- #}
                                            {% for field in dynamic_fields %}
                                            {% if field.category == 'Trim' %}
                                            <div class="col-md-4 mb-3">
                                                <label class="font-weight-600 small text-uppercase text-muted mb-1">
                                                    {{ field.name }}
                                                    {% if field.is_required %}<span class="text-danger">*</span>{% endif
                                                    %}
                                                </label>

                                                {% set existing_val = dynamic_values_map.get(field.id|string, '') %}

                                                {% if field.field_type == 'select' %}
                                                <select name="dynamic_field_{{ field.id }}"
                                                    class="form-control form-control-sm" {% if field.is_required
                                                    %}required{% endif %}>
                                                    <option value="">Select {{ field.name }}</option>
                                                    {% set options = field.options|from_json_safe %}
                                                    {% for opt in options %}
                                                    <option value="{{ opt }}" {% if opt==existing_val %}selected{% endif
                                                        %}>{{ opt }}</option>
                                                    {% endfor %}
                                                </select>
                                                {% elif field.field_type == 'textarea' %}
                                                <textarea name="dynamic_field_{{ field.id }}"
                                                    class="form-control form-control-sm" rows="2" {% if
                                                    field.is_required %}required{% endif
                                                    %}>{{ existing_val }}</textarea>
                                                {% else %}
                                                <input type="text" name="dynamic_field_{{ field.id }}"
                                                    class="form-control form-control-sm" value="{{ existing_val }}" {%
                                                    if field.is_required %}required{% endif %}>
                                                {% endif %}
                                            </div>
                                            {% endif %}
                                            {% endfor %}
                                            <div class="col-12 mt-2">
                                                <label class="font-weight-600 small text-uppercase text-muted mb-1">{{
                                                    form.trim_notes.label.text }}</label>
                                                {{ form.trim_notes(class="form-control form-control-sm", rows="2") }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Windows/Doors (Shared Row) -->
                        <div class="row">
                            <div class="col-lg-6" id="section-window" style="display:none;">
                                <div class="card mb-4 shadow-sm">
                                    <div class="card-header bg-light py-2">
                                        <h6 class="mb-0 text-dark font-weight-bold"><i
                                                class="fas fa-window-maximize mr-2"></i> Windows</h6>
                                    </div>
                                    <div class="card-body">
                                        {# Legacy fields removed #}
                                        {# --- DYNAMIC WINDOW FIELDS --- #}
                                        {% for field in dynamic_fields %}
                                        {% if field.category == 'Window' %}
                                        <div class="form-group mb-2">
                                            <label class="font-weight-600 small text-uppercase text-muted mb-1">
                                                {{ field.name }}
                                                {% if field.is_required %}<span class="text-danger">*</span>{% endif %}
                                            </label>

                                            {% set existing_val = dynamic_values_map.get(field.id|string, '') %}

                                            {% if field.field_type == 'select' %}
                                            <select name="dynamic_field_{{ field.id }}"
                                                class="form-control form-control-sm" {% if field.is_required
                                                %}required{% endif %}>
                                                <option value="">Select {{ field.name }}</option>
                                                {% set options = field.options|from_json_safe %}
                                                {% for opt in options %}
                                                <option value="{{ opt }}" {% if opt==existing_val %}selected{% endif %}>
                                                    {{ opt }}</option>
                                                {% endfor %}
                                            </select>
                                            {% elif field.field_type == 'textarea' %}
                                            <textarea name="dynamic_field_{{ field.id }}"
                                                class="form-control form-control-sm" rows="2" {% if field.is_required
                                                %}required{% endif %}>{{ existing_val }}</textarea>
                                            {% else %}
                                            <input type="text" name="dynamic_field_{{ field.id }}"
                                                class="form-control form-control-sm" value="{{ existing_val }}" {% if
                                                field.is_required %}required{% endif %}>
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                        {% endfor %}
                                        <div class="mt-2">
                                            <label class="font-weight-600 small text-uppercase text-muted mb-1">{{
                                                form.window_notes.label.text }}</label>
                                            {{ form.window_notes(class="form-control form-control-sm", rows="2") }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6" id="section-door" style="display:none;">
                                <div class="card mb-4 shadow-sm">
                                    <div class="card-header bg-light py-2">
                                        <h6 class="mb-0 text-dark font-weight-bold"><i
                                                class="fas fa-door-open mr-2"></i> Doors</h6>
                                    </div>
                                    <div class="card-body">
                                        {# Legacy fields removed #}
                                        {# --- DYNAMIC DOOR FIELDS --- #}
                                        {% for field in dynamic_fields %}
                                        {% if field.category == 'Door' %}
                                        <div class="form-group mb-2">
                                            <label class="font-weight-600 small text-uppercase text-muted mb-1">
                                                {{ field.name }}
                                                {% if field.is_required %}<span class="text-danger">*</span>{% endif %}
                                            </label>

                                            {% set existing_val = dynamic_values_map.get(field.id|string, '') %}

                                            {% if field.field_type == 'select' %}
                                            <select name="dynamic_field_{{ field.id }}"
                                                class="form-control form-control-sm" {% if field.is_required
                                                %}required{% endif %}>
                                                <option value="">Select {{ field.name }}</option>
                                                {% set options = field.options|from_json_safe %}
                                                {% for opt in options %}
                                                <option value="{{ opt }}" {% if opt==existing_val %}selected{% endif %}>
                                                    {{ opt }}</option>
                                                {% endfor %}
                                            </select>
                                            {% elif field.field_type == 'textarea' %}
                                            <textarea name="dynamic_field_{{ field.id }}"
                                                class="form-control form-control-sm" rows="2" {% if field.is_required
                                                %}required{% endif %}>{{ existing_val }}</textarea>
                                            {% else %}
                                            <input type="text" name="dynamic_field_{{ field.id }}"
                                                class="form-control form-control-sm" value="{{ existing_val }}" {% if
                                                field.is_required %}required{% endif %}>
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                        {% endfor %}
                                        <div class="mt-2">
                                            <label class="font-weight-600 small text-uppercase text-muted mb-1">{{
                                                form.door_notes.label.text }}</label>
                                            {{ form.door_notes(class="form-control form-control-sm", rows="2") }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group mt-4">
                        <label class="font-weight-600 small text-uppercase tracking-wider">Notes</label>
                        {{ form.notes(class="input-modern", rows="4") }}
                    </div>

                    {% if not is_readonly %}
                    <div class="mt-5 pt-4 border-top d-flex justify-content-between">
                        <button type="submit" class="btn-premium px-5">
                            <i class="fas fa-save mr-2"></i> Update Bid Details
                        </button>
                        {% endif %}
                </fieldset>
            </form>

            {% if not is_readonly %}
            <form action="{{ url_for('main.delete_bid', bid_id=bid.id) }}" method="POST" class="d-inline">
                <button type="submit" class="btn text-danger font-weight-600"
                    onclick="return confirm('Are you sure you want to delete this bid? This action cannot be undone.');">
                    <i class="fas fa-trash-alt mr-2"></i> Delete Bid
                </button>
            </form>
        </div>
        {% endif %}
    </div>
</div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Section Toggles Logic
    const sectionMap = {
        'toggle_framing': 'section-framing',
        'toggle_siding': 'section-siding',
        'toggle_shingle': 'section-shingle',
        'toggle_deck': 'section-deck',
        'toggle_trim': 'section-trim',
        'toggle_window': 'section-window',
        'toggle_door': 'section-door'
    };

    function toggleSection(toggleId) {
        const toggle = document.getElementById(toggleId);
        const sectionId = sectionMap[toggleId];
        const section = document.getElementById(sectionId);

        if (toggle && section) {
            // Logic for handling display:flex vs block based on structure
            // For shared row (cols), use block. For full rows, use flex (or block).
            // Since I used 'row' class for full width sections, display:flex is correct.

            if (['section-window', 'section-door'].includes(sectionId)) {
                // section is the col-lg-6 div
                section.style.display = toggle.checked ? 'block' : 'none';
                // Ensure parent row is visible (it should be always valid if it contains these cols)
            } else {
                // Full width rows
                section.style.display = toggle.checked ? 'flex' : 'none';
            }
        }
    }

    // Attach listeners
    Object.keys(sectionMap).forEach(toggleId => {
        const toggle = document.getElementById(toggleId);
        if (toggle) {
            toggle.addEventListener('change', () => toggleSection(toggleId));
            // Run on init
            toggleSection(toggleId);
        }
    });

    // Master Toggle Removed

    // Toggle Flexible Bid Date
    const bidDateInput = document.getElementById('bid_date');
    const flexibleDateContainer = document.getElementById('flexible-date-container');
    const flexibleDateCheckbox = document.getElementById('flexibleBidDate');

    function toggleFlexibleDate() {
        if (bidDateInput.value) {
            flexibleDateContainer.style.display = 'block';
        } else {
            flexibleDateContainer.style.display = 'none';
            flexibleDateCheckbox.checked = false; // Reset if hidden
        }
    }

    if (bidDateInput) {
        bidDateInput.addEventListener('change', toggleFlexibleDate);
        // Also listen for input event just in case
        bidDateInput.addEventListener('input', toggleFlexibleDate);
        toggleFlexibleDate(); // Run on load
    }

    // --- New Multiple File Upload Logic ---
    (function () {
        var uploadedFiles = []; // { key, filename, type }
        var bidFilesJsonInput = document.getElementById('bid_files_json');
        var multiFileInput = document.getElementById('file_multi');
        var multiFileList = document.getElementById('multi-file-list');

        function updateBidFilesJson() {
            if (bidFilesJsonInput) {
                bidFilesJsonInput.value = JSON.stringify(uploadedFiles);
            }
        }

        if (multiFileInput) {
            multiFileInput.addEventListener('change', function () {
                var files = Array.from(this.files);
                if (files.length === 0) return;

                // Process each file
                files.forEach(function (file) {
                    uploadSingleFile(file);
                });
            });
        }

        function uploadSingleFile(file) {
            // Create UI element for this file
            var fileId = 'file-' + Math.random().toString(36).substr(2, 9);
            var itemHtml = `
                <div id="${fileId}" class="d-flex align-items-center justify-content-between p-2 mb-2 bg-white rounded border">
                    <div class="text-truncate mr-3" style="max-width: 200px;">
                        <i class="fas fa-file-pdf text-danger mr-2"></i><strong>${file.name}</strong>
                    </div>
                    <div class="flex-grow-1 mx-3">
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar bg-primary" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                    <small class="status-text text-muted">Waiting...</small>
                </div>
            `;
            multiFileList.insertAdjacentHTML('beforeend', itemHtml);

            var row = document.getElementById(fileId);
            var progressBar = row.querySelector('.progress-bar');
            var statusText = row.querySelector('.status-text');

            // Grab CSRF token
            var csrfInput = document.querySelector('input[name="csrf_token"]');
            var csrfToken = csrfInput ? csrfInput.value : '';

            statusText.textContent = 'Signing...';

            // 1. Get Presigned URL
            // For manage_bid, we can get customer_id from the form or the bid object. Form is safer if they changed it, but bid ID is fixed.
            var customerId = document.getElementById('customer_id') ? document.getElementById('customer_id').value : "{{ bid.customer_id }}";
            var bidId = "{{ bid.id }}";

            fetch("{{ url_for('main.sign_s3') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    filename: file.name,
                    file_type: file.type || 'application/octet-stream',
                    folder: 'bids',
                    customer_id: customerId,
                    bid_id: bidId
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.error) throw new Error(data.error);

                    // 2. Upload
                    statusText.textContent = 'Uploading...';
                    var formData = new FormData();
                    for (var key in data.fields) {
                        formData.append(key, data.fields[key]);
                    }
                    formData.append('file', file);

                    var xhr = new XMLHttpRequest();
                    xhr.open('POST', data.url);

                    xhr.upload.onprogress = function (e) {
                        if (e.lengthComputable) {
                            var percent = Math.round((e.loaded / e.total) * 100);
                            progressBar.style.width = percent + '%';
                        }
                    };

                    xhr.onload = function () {
                        if (xhr.status === 204 || xhr.status === 200) {
                            statusText.textContent = 'Done';
                            statusText.classList.add('text-success');
                            statusText.classList.remove('text-muted');
                            progressBar.classList.add('bg-success');
                            progressBar.classList.remove('bg-primary');

                            // Add to global list
                            uploadedFiles.push({
                                key: data.fields.key,
                                filename: file.name,
                                file_type: 'other'
                            });
                            updateBidFilesJson();
                        } else {
                            statusText.textContent = 'Failed';
                            statusText.classList.add('text-danger');
                            progressBar.classList.add('bg-danger');
                        }
                    };

                    xhr.onerror = function () {
                        statusText.textContent = 'Error';
                        statusText.classList.add('text-danger');
                    };

                    xhr.send(formData);
                })
                .catch(err => {
                    console.error(err);
                    statusText.textContent = 'Error';
                    statusText.classList.add('text-danger');
                });
        }
    })();
</script>
{% endblock %}