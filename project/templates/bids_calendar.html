{% extends "base.html" %}

{% block title %}Bids Calendar - Beisser.io{% endblock %}

{% block styles %}
<!-- FullCalendar CSS -->
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css' rel='stylesheet' />
<style>
    #calendar {
        max-width: 1100px;
        margin: 0 auto;
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .fc-event {
        cursor: pointer;
        padding: 2px 4px;
        border-radius: 4px;
        font-size: 0.85em;
    }

    .fc-toolbar-title {
        font-size: 1.5em !important;
        font-weight: bold;
        color: #333;
    }

    .legend {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-bottom: 20px;
    }

    .legend-item {
        display: flex;
        align-items: center;
        font-size: 0.9em;
    }

    .color-box {
        width: 15px;
        height: 15px;
        margin-right: 8px;
        border-radius: 3px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-3">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Bids Calendar</h2>
        <div class="d-flex align-items-center">
            <label for="branch_id" class="mr-2 mb-0">Branch:</label>
            <select name="branch_id" id="branch_filter" class="form-control" style="width: auto;">
                <option value="0" {% if current_branch_id==0 %}selected{% endif %}>All Branches</option>
                {% for branch in branches %}
                <option value="{{ branch.branch_id }}" {% if current_branch_id==branch.branch_id %}selected{% endif %}>
                    {{ branch.branch_name }}
                </option>
                {% endfor %}
            </select>
            <a href="{{ url_for('main.open_bids', branch_id=current_branch_id) }}" class="btn btn-outline-primary ml-3">
                <i class="fas fa-list"></i> Table View
            </a>
        </div>
    </div>

    <div class="legend">
        <div class="legend-item">
            <div class="color-box" style="background-color: #00008b;"></div>
            <span>Residential</span>
        </div>
        <div class="legend-item">
            <div class="color-box" style="background-color: #6c757d;"></div>
            <span>Commercial</span>
        </div>
    </div>

    <div id='calendar'></div>
</div>

<!-- Modal for Bid Details (Optional, but could be nice) -->
{% endblock %}

{% block scripts %}
<!-- FullCalendar JS -->
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js'></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var calendarEl = document.getElementById('calendar');
        var branchFilter = document.getElementById('branch_filter');

        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek'
            },
            events: {
                url: "{{ url_for('main.api_bids_events') }}",
                extraParams: function () {
                    return {
                        branch_id: branchFilter.value
                    };
                }
            },
            eventClick: function (info) {
                if (info.event.url) {
                    window.location.href = info.event.url;
                    info.jsEvent.preventDefault(); // don't let the browser navigate
                }
            },
            eventDidMount: function (info) {
                // Add tooltip or popover here if desired
                $(info.el).tooltip({
                    title: info.event.title,
                    placement: 'top',
                    trigger: 'hover',
                    container: 'body'
                });
            },
            height: 'auto'
        });

        calendar.render();

        // Refetch events when branch filter changes
        branchFilter.addEventListener('change', function () {
            calendar.refetchEvents();

            // Update the "Table View" link when branch changes
            const tableViewBtn = document.querySelector('a[href*="open_bids"]');
            const baseUrl = "{{ url_for('main.open_bids') }}";
            tableViewBtn.href = `${baseUrl}?branch_id=${branchFilter.value}`;
        });
    });
</script>
{% endblock %}