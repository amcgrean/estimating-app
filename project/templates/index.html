{% extends "base.html" %}

{% block title %}Dashboard | Beisser.io{% endblock %}

{% block styles %}
<style>
    .stats-card {
        padding: var(--space-md);
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        min-height: 120px;
    }

    .stats-card .label {
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--text-muted);
        margin-bottom: var(--space-xs);
    }

    .stats-card .value {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--text-main);
        font-family: 'Outfit', sans-serif;
    }

    .stats-card .trend {
        font-size: 0.75rem;
        font-weight: 600;
        margin-top: var(--space-sm);
    }

    .header-section {
        margin-bottom: var(--space-xl);
    }

    .branch-selector {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        padding: 0.25rem 0.75rem;
        font-weight: 500;
    }

    .quick-link-card {
        text-align: center;
        padding: var(--space-lg);
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: var(--space-sm);
        color: var(--text-main);
        text-decoration: none !important;
    }

    .quick-link-card i {
        font-size: 1.5rem;
        color: var(--primary);
    }

    .table-container {
        background: var(--surface);
        border-radius: var(--radius-lg);
        overflow: hidden;
        border: 1px solid var(--border);
    }

    .table thead th {
        background: var(--surface-muted);
        border-bottom: 2px solid var(--border);
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        padding: 1rem;
    }

    .table td {
        padding: 1rem;
        vertical-align: middle;
        font-size: 0.9rem;
    }
</style>
.fc-event {
cursor: pointer;
}
.fc-toolbar-title {
font-size: 1.25rem !important;
}
</style>
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css' rel='stylesheet' />
{% endblock %}

{% block content %}
<div class="row align-items-center mb-4">
    <div class="col-md-6">
        <h1 class="h3 font-weight-bold mb-0" style="font-family: 'Outfit', sans-serif;">Dashboard</h1>
    </div>
    <div class="col-md-6 d-flex justify-content-end align-items-center">
        <!-- Dashboard Search -->
        <form action="{{ url_for('main.index') }}" method="GET" class="mr-3 flex-grow-1 d-none d-md-block"
            style="max-width: 300px;">
            <div class="input-group">
                <input type="text" name="search" class="form-control form-control-sm border-0 shadow-none bg-light"
                    placeholder="Search bids & designs..." value="{{ search_query or '' }}"
                    style="border-radius: var(--radius-pill) 0 0 var(--radius-pill); padding-left: 1.25rem;">
                <div class="input-group-append">
                    <button class="btn btn-sm btn-light border-0" type="submit"
                        style="border-radius: 0 var(--radius-pill) var(--radius-pill) 0; padding-right: 1rem;">
                        <i class="fas fa-search text-muted"></i>
                    </button>
                </div>
            </div>
        </form>

        <!-- Compact Quick Actions -->
        <div class="dropdown mr-4">
            <button class="btn-premium dropdown-toggle py-2 px-3" type="button" id="quickActionsMenu"
                data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <i class="fas fa-plus-circle mr-2"></i> Quick Actions
            </button>
            <div class="dropdown-menu dropdown-menu-right shadow-lg border-0" aria-labelledby="quickActionsMenu"
                style="border-radius: var(--radius-md);">
                <a class="dropdown-item py-2" href="{{ url_for('main.add_bid', branch_id=current_branch_id) }}">
                    <i class="fas fa-plus-circle mr-2 text-primary"></i> Add Bid
                </a>
                <a class="dropdown-item py-2" href="{{ url_for('main.add_design', branch_id=current_branch_id) }}">
                    <i class="fas fa-pen-nib mr-2 text-primary"></i> Add Design
                </a>

                {% if current_user.is_admin %}
                <div class="dropdown-divider"></div>
                <a class="dropdown-item py-2" href="{{ url_for('admin.manage_customers') }}">
                    <i class="fas fa-users mr-2 text-muted"></i> Customers
                </a>
                <a class="dropdown-item py-2" href="{{ url_for('admin.manage_users') }}">
                    <i class="fas fa-user-shield mr-2 text-muted"></i> Users
                </a>
                {% endif %}
            </div>
        </div>

    </div>
</div>

<!-- Compact Metrics Row -->
<div class="row mb-4 no-gutters" style="margin-left: -10px; margin-right: -10px;">
    <!-- Open Bids -->
    <div class="col-xl col-md-4 col-sm-6 px-2 mb-3">
        <a href="{{ url_for('main.open_bids', branch_id=current_branch_id) }}"
            class="text-decoration-none h-100 d-block">
            <div class="premium-card stats-card h-100 py-3"
                style="border-left: 4px solid var(--primary); min-height: 90px; position: relative; overflow: hidden;">
                <div
                    style="position: absolute; bottom: 0; left: 0; height: 4px; width: 65%; background: var(--primary); opacity: 0.3;">
                </div>
                <div class="d-flex justify-content-between align-items-start mb-1">
                    <span class="label mb-0">Open Bids</span>
                    <i class="fas fa-folder-open text-primary small"></i>
                </div>
                <div class="d-flex align-items-baseline justify-content-between">
                    <div class="value" style="font-size: 1.5rem;">{{ open_bids_count }}</div>
                    <div class="small text-primary font-weight-bold">View <i class="fas fa-arrow-right ml-1"></i></div>
                </div>
            </div>
        </a>
    </div>
    <!-- Bids YTD -->
    <div class="col-xl col-md-4 col-sm-6 px-2 mb-3">
        <div class="premium-card stats-card h-100 py-3"
            style="border-left: 4px solid var(--success); min-height: 90px; position: relative; overflow: hidden;">
            <div
                style="position: absolute; bottom: 0; left: 0; height: 4px; width: 85%; background: var(--success); opacity: 0.3;">
            </div>
            <div class="d-flex justify-content-between align-items-start mb-1">
                <span class="label mb-0">Bids YTD</span>
                <i class="fas fa-chart-line text-success small"></i>
            </div>
            <div class="value" style="font-size: 1.5rem;">{{ bids_ytd }}</div>
            <div class="trend text-success small m-0">MTD: {{ bids_mtd }}</div>
        </div>
    </div>
    <!-- Prev Bids YTD -->
    <div class="col-xl col-md-4 col-sm-6 px-2 mb-3">
        <div class="premium-card stats-card h-100 py-3"
            style="border-left: 4px solid var(--accent); min-height: 90px; position: relative; overflow: hidden;">
            <div
                style="position: absolute; bottom: 0; left: 0; height: 4px; width: 45%; background: var(--accent); opacity: 0.3;">
            </div>
            <div class="d-flex justify-content-between align-items-start mb-1">
                <span class="label mb-0">Prev. Bids YTD</span>
                <i class="fas fa-history text-warning small"></i>
            </div>
            <div class="value" style="font-size: 1.5rem;">{{ prev_bids_ytd }}</div>
            <div class="trend text-warning small m-0">MTD: {{ prev_bids_mtd }}</div>
        </div>
    </div>
    <!-- Open Designs -->
    <div class="col-xl col-md-4 col-sm-6 px-2 mb-3">
        <a href="{{ url_for('main.open_designs', branch_id=current_branch_id) }}"
            class="text-decoration-none h-100 d-block">
            <div class="premium-card stats-card h-100 py-3"
                style="border-left: 4px solid var(--primary); min-height: 90px;">
                <div class="d-flex justify-content-between align-items-start mb-1">
                    <span class="label mb-0">Open Designs</span>
                    <i class="fas fa-drafting-pencil text-primary small"></i>
                </div>
                <div class="d-flex align-items-baseline justify-content-between">
                    <div class="value" style="font-size: 1.5rem;">{{ open_designs_count }}</div>
                    <div class="small text-primary font-weight-bold">View <i class="fas fa-arrow-right ml-1"></i></div>
                </div>
            </div>
        </a>
    </div>
    <!-- Designs YTD -->
    <div class="col-xl col-md-4 col-sm-6 px-2 mb-3">
        <div class="premium-card stats-card h-100 py-3"
            style="border-left: 4px solid var(--success); min-height: 90px;">
            <div class="d-flex justify-content-between align-items-start mb-1">
                <span class="label mb-0">Designs YTD</span>
                <i class="fas fa-pencil-ruler text-success small"></i>
            </div>
            <div class="value" style="font-size: 1.5rem;">{{ designs_ytd }}</div>
            <div class="trend text-success small m-0">MTD: {{ designs_mtd }}</div>
        </div>
    </div>
    <!-- Avg Turnaround -->
    <div class="col-xl col-md-4 col-sm-6 px-2 mb-3">
        <div class="premium-card stats-card h-100 py-3" style="border-left: 4px solid var(--info); min-height: 90px;">
            <div class="d-flex justify-content-between align-items-start mb-1">
                <span class="label mb-0">Avg. Turnaround</span>
                <i class="fas fa-clock text-info small"></i>
            </div>
            <div class="value" style="font-size: 1.5rem;">{{ avg_completion_time }}d</div>
            <div class="small text-muted m-0">Completion avg</div>
        </div>
    </div>
</div>

<!-- Coralville Calendar (Conditional) -->
{% if current_branch_id == 3 %}
<div class="row mb-4">
    <div class="col-12">
        <div class="premium-card p-4">
            <h5 class="mb-4 font-weight-bold">
                <i class="fas fa-calendar-alt text-primary mr-2"></i> Bid Calendar (Coralville)
            </h5>
            <div id='calendar'></div>
        </div>
    </div>
</div>
{% endif %}

<!-- Search Results & Tables -->
<div class="row">
    <div class="col-12">
        {% if search_query %}
        <div class="premium-card mb-4 py-3">
            <h5 class="mb-3 px-3 d-flex justify-content-between align-items-center">
                <span>Search Results for "<mark class="p-0 bg-warning text-dark">{{ search_query }}</mark>"</span>
                <span class="badge badge-light px-3 py-2" style="border-radius: var(--radius-pill);">{{ (bids|length) +
                    (designs|length) }} results</span>
            </h5>
            {% if not bids and not designs %}
            <div class="text-center py-5">
                <div class="mb-3"><i class="fas fa-search-minus fa-3x text-muted opacity-50"></i></div>
                <h5 class="text-muted">No matches found</h5>
                <p class="small text-muted mb-4">Try adjusting your keywords or branch filter.</p>
                <div class="d-flex justify-content-center gap-2">
                    <a href="{{ url_for('main.add_bid') }}" class="btn btn-sm btn-primary">Quick Add Bid</a>
                    <a href="{{ url_for('main.index') }}" class="btn btn-sm btn-outline-secondary">Clear Search</a>
                </div>
            </div>
            {% else %}
            <div class="table-responsive">
                <table class="table-premium mb-0 table-sm">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Project Name</th>
                            <th>Status</th>
                            <th>Customer</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for bid in bids %}
                        <tr>
                            <td><span class="badge-premium badge-active">Bid</span></td>
                            <td><a href="{{ url_for('main.manage_bid', bid_id=bid.id) }}"
                                    class="font-weight-600 text-primary">{{ bid.project_name }}</a></td>
                            <td>
                                {% if bid.status == 'Incomplete' %}
                                <span class="badge-premium badge-incomplete py-0 px-2"
                                    style="font-size: 0.75rem;">Incomplete</span>
                                {% elif bid.status == 'Complete' %}
                                <span class="badge-premium badge-complete py-0 px-2"
                                    style="font-size: 0.75rem;">Complete</span>
                                {% else %}
                                <span class="badge-premium badge-active py-0 px-2" style="font-size: 0.75rem;">{{
                                    bid.status }}</span>
                                {% endif %}
                            </td>
                            <td class="small">{{ bid.customer.name }}</td>
                        </tr>
                        {% endfor %}
                        {% for design in designs %}
                        <tr>
                            <td><span class="badge-premium py-0 px-2"
                                    style="background: #e0f2fe; color: #0369a1; font-size: 0.75rem;">Design</span></td>
                            <td><a href="{{ url_for('main.manage_design', design_id=design.id) }}"
                                    class="font-weight-600 text-primary">{{ design.plan_name }}</a></td>
                            <td><span class="badge-premium badge-active py-0 px-2" style="font-size: 0.75rem;">{{
                                    design.status }}</span></td>
                            <td class="small">{{ design.customer.name }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}
        </div>
        {% endif %}

        <div class="row">
            <div class="col-lg-8">
                <div class="premium-card mb-4 py-3">
                    <h5 class="mb-3 d-flex align-items-center px-3">
                        <i class="fas fa-clock text-muted mr-2 small"></i> Recently Updated
                    </h5>
                    <div class="table-responsive">
                        <table class="table mb-0 table-sm">
                            <thead>
                                <tr>
                                    <th>Project</th>
                                    <th>Status</th>
                                    <th>Updated At</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for project in recently_opened_projects %}
                                <tr>
                                    <td><a href="{{ url_for('main.manage_bid', bid_id=project.id) }}"
                                            class="font-weight-600 text-primary">{{ project.project_name }}</a></td>
                                    <td>
                                        {% if project.status == 'Incomplete' %}
                                        <span class="badge-premium badge-incomplete py-0 px-2"
                                            style="font-size: 0.75rem;">Incomplete</span>
                                        {% elif project.status == 'Complete' %}
                                        <span class="badge-premium badge-complete py-0 px-2"
                                            style="font-size: 0.75rem;">Complete</span>
                                        {% else %}
                                        <span class="badge-premium badge-active py-0 px-2"
                                            style="font-size: 0.75rem;">{{ project.status }}</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-muted small">{{ project.last_updated_at.strftime('%m/%d %H:%M') }}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="premium-card py-3 mb-4">
                    <h5 class="mb-3 d-flex align-items-center px-3">
                        <i class="fas fa-star text-muted mr-2 small"></i> New Projects
                    </h5>
                    <ul class="list-unstyled mb-0 px-3">
                        {% for project in recently_created_projects %}
                        <li
                            class="{% if not loop.last %}mb-2 pb-2 border-bottom{% endif %} d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1 overflow-hidden">
                                <a href="{{ url_for('main.manage_bid', bid_id=project.id) }}"
                                    class="font-weight-600 text-primary d-block text-truncate small">{{
                                    project.project_name }}</a>
                                <span class="text-muted" style="font-size: 0.7rem;">Added {{
                                    project.log_date.strftime('%m/%d') }}</span>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{% if current_branch_id == 3 %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js'></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var calendarEl = document.getElementById('calendar');
        if (calendarEl) {
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek'
                },
                events: {
                    url: "{{ url_for('main.api_bids_events') }}",
                    extraParams: {
                        branch_id: 3
                    }
                },
                eventClick: function (info) {
                    if (info.event.url) {
                        window.location.href = info.event.url;
                        info.jsEvent.preventDefault();
                    }
                },
                height: 600,
                // Simple event styling
                eventDidMount: function (info) {
                    // Tooltip logic if needed
                    $(info.el).attr('title', info.event.title);
                }
            });
            calendar.render();
        }
    });
</script>
{% endif %}
{% endblock %}