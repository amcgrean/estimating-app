{% extends "base.html" %}

{% block title %}Add New Bid{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h2 class="display-5 font-weight-bold" style="font-family: 'Outfit', sans-serif;">Add New Bid</h2>
        <p class="text-muted small">Enter the details below to log a new bid request.</p>
    </div>
    <div class="col-md-4 text-right">
        <a href="{{ url_for('main.index') }}" class="btn btn-outline-secondary px-4 font-weight-600"
            style="border-radius: var(--radius-md);">
            <i class="fas fa-arrow-left mr-2"></i> Back to Dashboard
        </a>
    </div>
</div>

<div class="premium-card shadow-lg border-0" style="border-radius: var(--radius-lg);">
    <form action="{{ url_for('main.add_bid') }}" method="POST" enctype="multipart/form-data" class="p-2">
        {{ form.hidden_tag() }}

        <!-- Display Flash Messages explicitly if not caught by base template -->
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="alert alert-{{ category }}">{{ message }}</div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        <!-- Display Form Errors -->
        {% if form.errors %}
        <div class="alert alert-danger">
            Whoops! There were some errors with your submission:
            <ul>
                {% for field, errors in form.errors.items() %}
                {% for error in errors %}
                <li>{{ form[field].label.text if form[field].label else field }}: {{ error }}</li>
                {% endfor %}
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <div class="row">
            <!-- Left Column: Classification & Assignment -->
            <div class="col-lg-6 pr-lg-4 border-right">
                <h5 class="mb-4 text-primary d-flex align-items-center" style="font-size: 1rem; letter-spacing: 0.5px;">
                    <i class="fas fa-tags mr-2 small"></i> BASIC INFORMATION
                </h5>

                <div class="form-group mb-4">
                    <label class="font-weight-600 small text-uppercase tracking-wider mb-2">{{
                        form.project_name.label.text }}</label>
                    {{ form.project_name(class="input-modern", placeholder="e.g. Smith Residence - Framing") }}
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group mb-4">
                            <label class="font-weight-600 small text-uppercase tracking-wider mb-2">{{
                                form.plan_type.label.text }}</label>
                            {{ form.plan_type(class="input-modern") }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <!-- Status is typically Incomplete for new bids; hiding to simplify form -->
                        <div class="form-group mb-4" style="display: none;">
                            <label class="font-weight-600 small text-uppercase tracking-wider mb-2">{{
                                form.status.label.text }}</label>
                            {{ form.status(class="input-modern") }}
                        </div>
                    </div>
                </div>

                <div class="form-group mb-4">
                    <label class="font-weight-600 small text-uppercase tracking-wider mb-2">{{ form.branch_id.label.text
                        }}</label>
                    {{ form.branch_id(class="input-modern", disabled=True) }}
                    {% if form.branch_id.data %}
                    <input type="hidden" name="branch_id" value="{{ form.branch_id.data }}">
                    {% endif %}
                </div>

                <!-- File Uploads -->
                <h5 class="mb-3 mt-4 text-primary d-flex align-items-center"
                    style="font-size: 1rem; letter-spacing: 0.5px;">
                    <i class="fas fa-paperclip mr-2 small"></i> ATTACHMENTS
                </h5>
                <div class="p-3 bg-light rounded border mb-4">
                    <div class="form-group mb-3">
                        <label class="font-weight-600 small text-uppercase tracking-wider mb-1">{{
                            form.plan_file.label.text }}</label>
                        {{ form.plan_file(class="form-control-file", id="file_plan") }}
                        {{ form.plan_key(id="plan_key") }}
                        <small class="form-text text-muted">Upload architectural plans (PDF only)</small>

                        <!-- Progress Bar for Plan -->
                        <div id="progress-container-plan" class="progress mt-2 d-none" style="height: 10px;">
                            <div id="progress-bar-plan"
                                class="progress-bar bg-success progress-bar-striped progress-bar-animated"
                                role="progressbar" style="width: 0%"></div>
                        </div>
                        <small id="status-plan" class="text-success font-weight-bold d-none mt-1"></small>
                    </div>

                    <div class="form-group mb-0">
                        <label class="font-weight-600 small text-uppercase tracking-wider mb-1">{{
                            form.email_file.label.text }}</label>
                        {{ form.email_file(class="form-control-file", id="file_email") }}
                        {{ form.email_key(id="email_key") }}
                        <small class="form-text text-muted">Upload request email or other docs</small>

                        <!-- Progress Bar for Email -->
                        <div id="progress-container-email" class="progress mt-2 d-none" style="height: 10px;">
                            <div id="progress-bar-email"
                                class="progress-bar bg-success progress-bar-striped progress-bar-animated"
                                role="progressbar" style="width: 0%"></div>
                        </div>
                        <small id="status-email" class="text-success font-weight-bold d-none mt-1"></small>
                    </div>

                    <div class="form-group mb-0 mt-3 border-top pt-3">
                        <label class="font-weight-600 small text-uppercase tracking-wider mb-1">Additional Files
                            (Multiple)</label>
                        <input type="file" id="file_multi" class="form-control-file" multiple>
                        <input type="hidden" name="bid_files_json" id="bid_files_json">
                        <small class="form-text text-muted">Upload any other relevant PDFs or images.</small>

                        <div id="multi-file-list" class="mt-2">
                            <!-- JS will append progress bars here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Details & Dates -->
            <div class="col-lg-6 pl-lg-4">
                <h5 class="mb-4 text-primary d-flex align-items-center" style="font-size: 1rem; letter-spacing: 0.5px;">
                    <i class="fas fa-user-tie mr-2 small"></i> CUSTOMER & TIMELINE
                </h5>

                <div class="form-group mb-4">
                    <label class="font-weight-600 small text-uppercase tracking-wider mb-2">{{
                        form.customer_id.label.text }}</label>
                    {{ form.customer_id(class="input-modern select2-enable") }}
                </div>

                <div class="form-group mb-4">
                    <label class="font-weight-600 small text-uppercase tracking-wider mb-2">{{
                        form.estimator_id.label.text }}</label>
                    {% if current_user.usertype.name == 'Sales Rep' %}
                    <!-- Sales Reps cannot assign estimators -->
                    <div class="form-control bg-light text-muted">No Estimator Assigned</div>
                    <div style="display:none;">{{ form.estimator_id(class="input-modern") }}</div>
                    {% else %}
                    {{ form.estimator_id(class="input-modern") }}
                    {% endif %}
                </div>

                <div class="form-group mb-4">
                    {% if current_user.usertype.name == 'Sales Rep' %}
                    <!-- Sales Reps create bids for themselves automatically -->
                    <input type="hidden" name="sales_rep_id" value="{{ current_user.sales_rep_id }}">
                    {% else %}
                    <!-- Estimators/Admins assign a Sales Rep -->
                    <label class="font-weight-600 small text-uppercase tracking-wider mb-2">{{
                        form.sales_rep_id.label.text }}</label>
                    {{ form.sales_rep_id(class="input-modern") }}
                    {% endif %}
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group mb-4">
                            <label class="font-weight-600 small text-uppercase tracking-wider mb-2">{{
                                form.bid_date.label.text }} <span
                                    class="text-muted font-weight-normal">(Optional)</span></label>
                            {{ form.bid_date(class="input-modern", type="date") }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group mb-4">
                            <label class="font-weight-600 small text-uppercase tracking-wider mb-2">{{
                                form.due_date.label.text }}</label>
                            {{ form.due_date(class="input-modern", type="date") }}
                        </div>
                    </div>
                </div>

                <!-- Flexible Bid Date Toggle - Visible only when Bid Date is set -->
                <div class="form-group mb-4" id="flexible-date-container" style="display: none;">
                    <div class="custom-control custom-checkbox">
                        {{ form.flexible_bid_date(class="custom-control-input", id="flexibleBidDate") }}
                        <label class="custom-control-label font-weight-600 text-muted" for="flexibleBidDate">
                            {{ form.flexible_bid_date.label.text }}
                        </label>
                    </div>
                </div>

                <!-- Specs Toggle -->
                <div class="form-group mt-2">
                    <div class="custom-control custom-switch">
                        {{ form.include_specs(class="custom-control-input", id="includeSpecsToggle") }}
                        <label class="custom-control-label font-weight-bold ml-2 pt-1" for="includeSpecsToggle">Include
                            Detailed Specifications</label>
                    </div>
                    <small class="form-text text-muted ml-5">Enable to add specific notes for Framing, Siding,
                        etc.</small>
                </div>
            </div>

            <div class="col-12 mt-3 pt-3 border-top" id="specs-section" style="display: none;">
                <h5 class="mb-4 text-primary d-flex align-items-center" style="font-size: 1rem; letter-spacing: 0.5px;">
                    <i class="fas fa-list-alt mr-2 small"></i> MODULE SPECIFICATIONS
                </h5>

                <!-- Section Toggles -->
                <div class="row mb-4">
                    <div class="col-12">
                        <label class="font-weight-600 small text-uppercase tracking-wider mb-2">Select Sections to
                            Include:</label>
                        <div class="d-flex flex-wrap gap-3">
                            <div class="custom-control custom-checkbox mr-3 mb-2">
                                {{ form.include_framing(class="custom-control-input section-toggle",
                                id="toggle_framing") }}
                                <label class="custom-control-label" for="toggle_framing">Framing</label>
                            </div>
                            <div class="custom-control custom-checkbox mr-3 mb-2">
                                {{ form.include_siding(class="custom-control-input section-toggle", id="toggle_siding")
                                }}
                                <label class="custom-control-label" for="toggle_siding">Siding</label>
                            </div>
                            <div class="custom-control custom-checkbox mr-3 mb-2">
                                {{ form.include_shingle(class="custom-control-input section-toggle",
                                id="toggle_shingle") }}
                                <label class="custom-control-label" for="toggle_shingle">Shingles</label>
                            </div>
                            <div class="custom-control custom-checkbox mr-3 mb-2">
                                {{ form.include_deck(class="custom-control-input section-toggle", id="toggle_deck") }}
                                <label class="custom-control-label" for="toggle_deck">Deck</label>
                            </div>
                            <div class="custom-control custom-checkbox mr-3 mb-2">
                                {{ form.include_trim(class="custom-control-input section-toggle", id="toggle_trim") }}
                                <label class="custom-control-label" for="toggle_trim">Trim</label>
                            </div>
                            <div class="custom-control custom-checkbox mr-3 mb-2">
                                {{ form.include_window(class="custom-control-input section-toggle", id="toggle_window")
                                }}
                                <label class="custom-control-label" for="toggle_window">Window</label>
                            </div>
                            <div class="custom-control custom-checkbox mr-3 mb-2">
                                {{ form.include_door(class="custom-control-input section-toggle", id="toggle_door") }}
                                <label class="custom-control-label" for="toggle_door">Door</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Framing Section (Full Width) -->
                <div class="row" id="section-framing" style="display:none;">
                    <div class="col-12">
                        <div class="card mb-4 shadow-sm">
                            <div class="card-header bg-light py-2">
                                <h6 class="mb-0 text-primary font-weight-bold"><i class="fas fa-hammer mr-2"></i>
                                    Framing</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <!-- Dynamic Fields for Framing -->
                                    {% for field in dynamic_fields %}
                                    {% if field.category == 'Framing' %}
                                    <div class="col-md-4 mb-3">
                                        <label class="font-weight-600 small text-uppercase text-muted mb-1">{{
                                            field.name }} {% if field.is_required %}<span class="text-danger">*</span>{%
                                            endif %}</label>
                                        {% if field.field_type == 'text' %}
                                        <input type="text" name="dynamic_field_{{ field.id }}"
                                            class="form-control form-control-sm" {% if field.is_required %}required{%
                                            endif %}>
                                        {% elif field.field_type == 'textarea' %}
                                        <textarea name="dynamic_field_{{ field.id }}"
                                            class="form-control form-control-sm" rows="3" {% if field.is_required
                                            %}required{% endif %}></textarea>
                                        {% elif field.field_type == 'select' %}
                                        <select name="dynamic_field_{{ field.id }}" class="form-control form-control-sm"
                                            {% if field.is_required %}required{% endif %}>
                                            <option value="">Select...</option>
                                            {% for option in field.options.split(',') %}
                                            <option value="{{ option.strip() }}">{{ option.strip() }}</option>
                                            {% endfor %}
                                        </select>
                                        {% elif field.field_type == 'checkbox' %}
                                        <div class="custom-control custom-checkbox mt-2">
                                            <input type="checkbox" class="custom-control-input"
                                                id="dyn_field_{{ field.id }}" name="dynamic_field_{{ field.id }}"
                                                value="Yes">
                                            <label class="custom-control-label"
                                                for="dyn_field_{{ field.id }}">Yes</label>
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Siding Section (Full Width) -->
                <div class="row" id="section-siding" style="display:none;">
                    <div class="col-12">
                        <div class="card mb-4 shadow-sm">
                            <div class="card-header bg-light py-2">
                                <h6 class="mb-0 text-info font-weight-bold"><i class="fas fa-layer-group mr-2"></i>
                                    Siding</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <!-- Dynamic Fields for Siding -->
                                    {% for field in dynamic_fields %}
                                    {% if field.category == 'Siding' %}
                                    <div class="col-md-4 mb-3">
                                        <label class="font-weight-600 small text-uppercase text-muted mb-1">{{
                                            field.name }} {% if field.is_required %}<span class="text-danger">*</span>{%
                                            endif %}</label>
                                        {% if field.field_type == 'text' %}
                                        <input type="text" name="dynamic_field_{{ field.id }}"
                                            class="form-control form-control-sm" {% if field.is_required %}required{%
                                            endif %}>
                                        {% elif field.field_type == 'textarea' %}
                                        <textarea name="dynamic_field_{{ field.id }}"
                                            class="form-control form-control-sm" rows="3" {% if field.is_required
                                            %}required{% endif %}></textarea>
                                        {% elif field.field_type == 'select' %}
                                        <select name="dynamic_field_{{ field.id }}" class="form-control form-control-sm"
                                            {% if field.is_required %}required{% endif %}>
                                            <option value="">Select...</option>
                                            {% for option in field.options.split(',') %}
                                            <option value="{{ option.strip() }}">{{ option.strip() }}</option>
                                            {% endfor %}
                                        </select>
                                        {% elif field.field_type == 'checkbox' %}
                                        <div class="custom-control custom-checkbox mt-2">
                                            <input type="checkbox" class="custom-control-input"
                                                id="dyn_field_{{ field.id }}" name="dynamic_field_{{ field.id }}"
                                                value="Yes">
                                            <label class="custom-control-label"
                                                for="dyn_field_{{ field.id }}">Yes</label>
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Shingle/Roof Section (Full Width - Moved here) -->
                <div class="row" id="section-shingle" style="display:none;">
                    <div class="col-12">
                        <div class="card mb-4 shadow-sm">
                            <div class="card-header bg-light py-2">
                                <h6 class="mb-0 text-secondary font-weight-bold"><i class="fas fa-home mr-2"></i>
                                    Shingle/Roof</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <!-- Dynamic Fields for Shingle -->
                                    {% for field in dynamic_fields %}
                                    {% if field.category == 'Shingle' %}
                                    <div class="col-md-12 mb-2">
                                        <label class="font-weight-600 small text-uppercase text-muted mb-1">{{
                                            field.name }} {% if field.is_required %}<span class="text-danger">*</span>{%
                                            endif %}</label>
                                        {% if field.field_type == 'text' %}
                                        <input type="text" name="dynamic_field_{{ field.id }}"
                                            class="form-control form-control-sm" {% if field.is_required %}required{%
                                            endif %}>
                                        {% elif field.field_type == 'textarea' %}
                                        <textarea name="dynamic_field_{{ field.id }}"
                                            class="form-control form-control-sm" rows="3" {% if field.is_required
                                            %}required{% endif %}></textarea>
                                        {% elif field.field_type == 'select' %}
                                        <select name="dynamic_field_{{ field.id }}" class="form-control form-control-sm"
                                            {% if field.is_required %}required{% endif %}>
                                            <option value="">Select...</option>
                                            {% for option in field.options.split(',') %}
                                            <option value="{{ option.strip() }}">{{ option.strip() }}</option>
                                            {% endfor %}
                                        </select>
                                        {% elif field.field_type == 'checkbox' %}
                                        <div class="custom-control custom-checkbox mt-2">
                                            <input type="checkbox" class="custom-control-input"
                                                id="dyn_field_{{ field.id }}" name="dynamic_field_{{ field.id }}"
                                                value="Yes">
                                            <label class="custom-control-label"
                                                for="dyn_field_{{ field.id }}">Yes</label>
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Deck Section (Full Width) -->
                <div class="row" id="section-deck" style="display:none;">
                    <div class="col-12">
                        <div class="card mb-4 shadow-sm">
                            <div class="card-header bg-light py-2">
                                <h6 class="mb-0 text-success font-weight-bold"><i class="fas fa-umbrella mr-2"></i> Deck
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <!-- Dynamic Fields for Deck -->
                                    {% for field in dynamic_fields %}
                                    {% if field.category == 'Deck' %}
                                    <div class="col-md-4 mb-3">
                                        <label class="font-weight-600 small text-uppercase text-muted mb-1">{{
                                            field.name }} {% if field.is_required %}<span class="text-danger">*</span>{%
                                            endif %}</label>
                                        {% if field.field_type == 'text' %}
                                        <input type="text" name="dynamic_field_{{ field.id }}"
                                            class="form-control form-control-sm" {% if field.is_required %}required{%
                                            endif %}>
                                        {% elif field.field_type == 'textarea' %}
                                        <textarea name="dynamic_field_{{ field.id }}"
                                            class="form-control form-control-sm" rows="3" {% if field.is_required
                                            %}required{% endif %}></textarea>
                                        {% elif field.field_type == 'select' %}
                                        <select name="dynamic_field_{{ field.id }}" class="form-control form-control-sm"
                                            {% if field.is_required %}required{% endif %}>
                                            <option value="">Select...</option>
                                            {% for option in field.options.split(',') %}
                                            <option value="{{ option.strip() }}">{{ option.strip() }}</option>
                                            {% endfor %}
                                        </select>
                                        {% elif field.field_type == 'checkbox' %}
                                        <div class="custom-control custom-checkbox mt-2">
                                            <input type="checkbox" class="custom-control-input"
                                                id="dyn_field_{{ field.id }}" name="dynamic_field_{{ field.id }}"
                                                value="Yes">
                                            <label class="custom-control-label"
                                                for="dyn_field_{{ field.id }}">Yes</label>
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Trim Section (Full Width) -->
                <div class="row" id="section-trim" style="display:none;">
                    <div class="col-12">
                        <div class="card mb-4 shadow-sm">
                            <div class="card-header bg-light py-2">
                                <h6 class="mb-0 text-warning font-weight-bold"><i
                                        class="fas fa-ruler-combined mr-2"></i> Trim</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <!-- Dynamic Fields for Trim -->
                                    {% for field in dynamic_fields %}
                                    {% if field.category == 'Trim' %}
                                    <div class="col-md-4 mb-3">
                                        <label class="font-weight-600 small text-uppercase text-muted mb-1">{{
                                            field.name }} {% if field.is_required %}<span class="text-danger">*</span>{%
                                            endif %}</label>
                                        {% if field.field_type == 'text' %}
                                        <input type="text" name="dynamic_field_{{ field.id }}"
                                            class="form-control form-control-sm" {% if field.is_required %}required{%
                                            endif %}>
                                        {% elif field.field_type == 'textarea' %}
                                        <textarea name="dynamic_field_{{ field.id }}"
                                            class="form-control form-control-sm" rows="3" {% if field.is_required
                                            %}required{% endif %}></textarea>
                                        {% elif field.field_type == 'select' %}
                                        <select name="dynamic_field_{{ field.id }}" class="form-control form-control-sm"
                                            {% if field.is_required %}required{% endif %}>
                                            <option value="">Select...</option>
                                            {% for option in field.options.split(',') %}
                                            <option value="{{ option.strip() }}">{{ option.strip() }}</option>
                                            {% endfor %}
                                        </select>
                                        {% elif field.field_type == 'checkbox' %}
                                        <div class="custom-control custom-checkbox mt-2">
                                            <input type="checkbox" class="custom-control-input"
                                                id="dyn_field_{{ field.id }}" name="dynamic_field_{{ field.id }}"
                                                value="Yes">
                                            <label class="custom-control-label"
                                                for="dyn_field_{{ field.id }}">Yes</label>
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Windows and Doors (Shared Row) -->
                <div class="row">
                    <div class="col-lg-6" id="section-window" style="display:none;">
                        <div class="card mb-4 shadow-sm">
                            <div class="card-header bg-light py-2">
                                <h6 class="mb-0 text-dark font-weight-bold"><i class="fas fa-window-maximize mr-2"></i>
                                    Windows</h6>
                            </div>
                            <div class="card-body">
                                <!-- Dynamic Fields for Window -->
                                {% for field in dynamic_fields %}
                                {% if field.category == 'Window' %}
                                <div class="form-group mb-2">
                                    <label class="font-weight-600 small text-uppercase text-muted mb-1">{{ field.name }}
                                        {% if field.is_required %}<span class="text-danger">*</span>{% endif %}</label>
                                    {% if field.field_type == 'text' %}
                                    <input type="text" name="dynamic_field_{{ field.id }}"
                                        class="form-control form-control-sm" {% if field.is_required %}required{% endif
                                        %}>
                                    {% elif field.field_type == 'textarea' %}
                                    <textarea name="dynamic_field_{{ field.id }}" class="form-control form-control-sm"
                                        rows="3" {% if field.is_required %}required{% endif %}></textarea>
                                    {% elif field.field_type == 'select' %}
                                    <select name="dynamic_field_{{ field.id }}" class="form-control form-control-sm" {%
                                        if field.is_required %}required{% endif %}>
                                        <option value="">Select...</option>
                                        {% for option in field.options.split(',') %}
                                        <option value="{{ option.strip() }}">{{ option.strip() }}</option>
                                        {% endfor %}
                                    </select>
                                    {% elif field.field_type == 'checkbox' %}
                                    <div class="custom-control custom-checkbox mt-2">
                                        <input type="checkbox" class="custom-control-input"
                                            id="dyn_field_{{ field.id }}" name="dynamic_field_{{ field.id }}"
                                            value="Yes">
                                        <label class="custom-control-label" for="dyn_field_{{ field.id }}">Yes</label>
                                    </div>
                                    {% endif %}
                                </div>
                                {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6" id="section-door" style="display:none;">
                        <div class="card mb-4 shadow-sm">
                            <div class="card-header bg-light py-2">
                                <h6 class="mb-0 text-dark font-weight-bold"><i class="fas fa-door-open mr-2"></i> Doors
                                </h6>
                            </div>
                            <div class="card-body">
                                <!-- Dynamic Fields for Door -->
                                {% for field in dynamic_fields %}
                                {% if field.category == 'Door' %}
                                <div class="form-group mb-2">
                                    <label class="font-weight-600 small text-uppercase text-muted mb-1">{{ field.name }}
                                        {% if field.is_required %}<span class="text-danger">*</span>{% endif %}</label>
                                    {% if field.field_type == 'text' %}
                                    <input type="text" name="dynamic_field_{{ field.id }}"
                                        class="form-control form-control-sm" {% if field.is_required %}required{% endif
                                        %}>
                                    {% elif field.field_type == 'textarea' %}
                                    <textarea name="dynamic_field_{{ field.id }}" class="form-control form-control-sm"
                                        rows="3" {% if field.is_required %}required{% endif %}></textarea>
                                    {% elif field.field_type == 'select' %}
                                    <select name="dynamic_field_{{ field.id }}" class="form-control form-control-sm" {%
                                        if field.is_required %}required{% endif %}>
                                        <option value="">Select...</option>
                                        {% for option in field.options.split(',') %}
                                        <option value="{{ option.strip() }}">{{ option.strip() }}</option>
                                        {% endfor %}
                                    </select>
                                    {% elif field.field_type == 'checkbox' %}
                                    <div class="custom-control custom-checkbox mt-2">
                                        <input type="checkbox" class="custom-control-input"
                                            id="dyn_field_{{ field.id }}" name="dynamic_field_{{ field.id }}"
                                            value="Yes">
                                        <label class="custom-control-label" for="dyn_field_{{ field.id }}">Yes</label>
                                    </div>
                                    {% endif %}
                                </div>
                                {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- General Notes -->
            <div class="col-12 mt-4 pt-4 border-top">
                <div class="form-group mb-4">
                    <label class="font-weight-600 small text-uppercase tracking-wider mb-2">{{ form.notes.label.text
                        }}</label>
                    {{ form.notes(class="input-modern", rows="3", placeholder="Any additional project details...") }}
                </div>

                <div class="d-flex justify-content-end gap-3 mt-4">
                    <a href="{{ url_for('main.index') }}" class="btn btn-outline-secondary px-4 py-3">Cancel</a>
                    <button type="submit" class="btn-premium px-5 py-3">
                        <i class="fas fa-check-circle mr-2"></i> {{ form.submit.label.text }}
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.getElementById('branch_id').onchange = function () {
        var branchId = this.value;
        var url = new URL(window.location.href);
        url.searchParams.set('branch_id', branchId);
        window.location.href = url.toString();
    };



    // Section Toggles Logic
    const sectionMap = {
        'toggle_framing': 'section-framing',
        'toggle_siding': 'section-siding',
        'toggle_shingle': 'section-shingle',
        'toggle_deck': 'section-deck',
        'toggle_trim': 'section-trim',
        'toggle_window': 'section-window',
        'toggle_door': 'section-door'
    };

    function toggleSection(toggleId) {
        const toggle = document.getElementById(toggleId);
        const sectionId = sectionMap[toggleId];
        const section = document.getElementById(sectionId);

        if (toggle && section) {
            section.style.display = toggle.checked ? (['section-window', 'section-door'].includes(sectionId) ? 'block' : 'flex') : 'none';
            if (['section-window', 'section-door'].includes(sectionId)) {
                section.parentElement.closest('.row').style.display = 'flex'; // Ensure parent row is visible
            }
            // For Bootstrap rows, 'flex' is default, but 'block' works for divs inside cols.
            // Actually, for the full width rows (col-12), the row itself is hidden.
            // Let's use 'flex' for row, or just remove display:none.
            section.style.display = toggle.checked ? 'flex' : 'none';

            // Special handling for shared row (Windows/Doors)
            if (['section-window', 'section-door'].includes(sectionId)) {
                // section is the col-lg-6 div
                section.style.display = toggle.checked ? 'block' : 'none';
            }
        }
    }

    // Attach listeners
    Object.keys(sectionMap).forEach(toggleId => {
        const toggle = document.getElementById(toggleId);
        if (toggle) {
            toggle.addEventListener('change', () => toggleSection(toggleId));
            // Run on init
            toggleSection(toggleId);
        }
    });

    // Master Specs Toggle (Optional: You might want to remove this if sections are independent, 
    // or use it to show/hide the whole block. 
    // Based on user request "include in bid at the top... ensure they are off by default by section until user marks sections"
    // I will assume the outer "Include Detailed Specifications" toggle is removed or always true?
    // The user said: "we need to have the 'include in bid' at the top of the specs still where we have the user mark the sections"
    // So the section checkboxes REPLACE the functionality of the master toggle somewhat, OR the master toggle shows the checkboxes.
    // Let's keep the master toggle to show/hide the entire "MODULE SPECIFICATIONS" block, and inside that block, the user toggles sections.

    const specsToggle = document.getElementById('includeSpecsToggle');
    const specsSection = document.getElementById('specs-section');

    function toggleSpecs() {
        if (specsToggle && specsSection) {
            if (specsToggle.checked) {
                specsSection.style.display = 'block';
            } else {
                specsSection.style.display = 'none';
            }
        }
    }

    if (specsToggle) {
        specsToggle.addEventListener('change', toggleSpecs);
        toggleSpecs();
    }

    // Toggle Flexible Bid Date
    const bidDateInput = document.getElementById('bid_date');
    const flexibleDateContainer = document.getElementById('flexible-date-container');
    const flexibleDateCheckbox = document.getElementById('flexibleBidDate');

    // --- S3 Direct Upload Logic ---
    // --- Auto-fill Sales Rep Logic ---
    {% if current_user.usertype.name != 'Sales Rep' %}
    var customerRepMap = {{ customer_sales_rep_map | tojson | default ('{}') }};
    var customerSelect = document.getElementById('customer_id'); // Ensure ID matches WTForms default
    var salesRepSelect = document.getElementById('sales_rep_id');

    if (customerSelect && salesRepSelect) {
        customerSelect.addEventListener('change', function () {
            var custId = this.value;
            // logic: if map has this custId, set salesRepSelect value
            if (customerRepMap.hasOwnProperty(custId)) {
                var repId = customerRepMap[custId];
                salesRepSelect.value = repId;
            } else {
                // Optional: Reset to "Select Sales Rep" or keep existing? 
                // Usually keeping existing is less annoying if they manually set it first.
                // But if they switch customers, maybe we should reset?
                // Let's only change if we find a match.
            }
        });
    }
    {% endif %}

    (function () {
        // Shared state for multiple files
        var uploadedFiles = []; // { key, filename, type }
        var bidFilesJsonInput = document.getElementById('bid_files_json');

        function updateBidFilesJson() {
            if (bidFilesJsonInput) {
                bidFilesJsonInput.value = JSON.stringify(uploadedFiles);
            }
        }

        function initS3Upload(fileId, keyId, progressId, barId, statusId, folder) {
            var fileInput = document.getElementById(fileId);
            var keyInput = document.getElementById(keyId);
            var progressContainer = document.getElementById(progressId);
            var progressBar = document.getElementById(barId);
            var statusText = document.getElementById(statusId);

            // Grab CSRF token from the form's hidden input
            var csrfInput = document.querySelector('input[name="csrf_token"]');
            var csrfToken = csrfInput ? csrfInput.value : '';

            if (!fileInput) return;

            fileInput.addEventListener('change', function () {
                var file = fileInput.files[0];
                if (!file) return;

                // Reset UI
                progressContainer.classList.remove('d-none');
                progressBar.style.width = '0%';
                progressBar.textContent = '0%';
                progressBar.classList.remove('bg-danger');
                progressBar.classList.add('bg-success');
                statusText.textContent = 'Preparing upload...';
                statusText.classList.remove('d-none', 'text-danger');
                statusText.classList.add('text-success');
                statusText.textContent = 'Signing upload...';

                // 1. Get Presigned URL
                var customerId = document.getElementById('customer_id') ? document.getElementById('customer_id').value : null;

                fetch("{{ url_for('main.sign_s3') }}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        filename: file.name,
                        file_type: file.type || 'application/octet-stream',
                        folder: folder,
                        customer_id: customerId // Pass customer ID for folder organization
                    })
                })
                    .then(response => {
                        if (!response.ok) throw new Error('Signing failed (' + response.status + ')');
                        return response.json();
                    })
                    .then(data => {
                        if (data.error) throw new Error(data.error);

                        // 2. Upload to S3
                        statusText.textContent = 'Uploading to S3...';
                        var formData = new FormData();
                        // Append fields in order
                        for (var key in data.fields) {
                            formData.append(key, data.fields[key]);
                        }
                        formData.append('file', file);

                        var xhr = new XMLHttpRequest();
                        xhr.open('POST', data.url);

                        xhr.upload.onprogress = function (e) {
                            if (e.lengthComputable) {
                                var percent = Math.round((e.loaded / e.total) * 100);
                                progressBar.style.width = percent + '%';
                                progressBar.textContent = percent + '%';
                            }
                        };

                        xhr.onload = function () {
                            if (xhr.status === 204 || xhr.status === 200) {
                                // Success
                                keyInput.value = data.fields.key; // Store key for backend
                                statusText.textContent = 'Upload Complete!';
                                progressBar.classList.remove('progress-bar-animated');

                                // Remove name attribute to prevent double upload to Flask
                                fileInput.removeAttribute('name');
                            } else {
                                statusText.textContent = 'Upload Failed!';
                                statusText.classList.add('text-danger');
                                progressBar.classList.add('bg-danger');
                                console.error('S3 Upload failed status: ' + xhr.status);
                            }
                        };

                        xhr.onerror = function () {
                            statusText.textContent = 'Network Error!';
                            statusText.classList.add('text-danger');
                            progressBar.classList.add('bg-danger');
                        };

                        xhr.send(formData);
                    })
                    .catch(error => {
                        console.error(error);
                        statusText.textContent = 'Error: ' + error.message;
                        statusText.classList.remove('text-success');
                        statusText.classList.add('text-danger');
                        progressBar.classList.remove('bg-success');
                        progressBar.classList.add('bg-danger');
                    });
            });
        }

        // Init legacy uploads
        initS3Upload('file_plan', 'plan_key', 'progress-container-plan', 'progress-bar-plan', 'status-plan', 'plans');
        initS3Upload('file_email', 'email_key', 'progress-container-email', 'progress-bar-email', 'status-email', 'emails');

        // --- New Multiple File Upload Logic ---
        var multiFileInput = document.getElementById('file_multi');
        var multiFileList = document.getElementById('multi-file-list');

        if (multiFileInput) {
            multiFileInput.addEventListener('change', function () {
                var files = Array.from(this.files);
                if (files.length === 0) return;

                // Process each file
                files.forEach(function (file) {
                    uploadSingleFile(file);
                });

                // Clear input so same files can be selected again if needed (or just reset)
                // this.value = ''; 
            });
        }

        function uploadSingleFile(file) {
            // Create UI element for this file
            var fileId = 'file-' + Math.random().toString(36).substr(2, 9);
            var itemHtml = `
                <div id="${fileId}" class="d-flex align-items-center justify-content-between p-2 mb-2 bg-white rounded border">
                    <div class="text-truncate mr-3" style="max-width: 200px;">
                        <i class="fas fa-file-pdf text-danger mr-2"></i><strong>${file.name}</strong>
                    </div>
                    <div class="flex-grow-1 mx-3">
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar bg-primary" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                    <small class="status-text text-muted">Waiting...</small>
                </div>
            `;
            multiFileList.insertAdjacentHTML('beforeend', itemHtml);

            var row = document.getElementById(fileId);
            var progressBar = row.querySelector('.progress-bar');
            var statusText = row.querySelector('.status-text');

            // Grab CSRF token
            var csrfInput = document.querySelector('input[name="csrf_token"]');
            var csrfToken = csrfInput ? csrfInput.value : '';

            statusText.textContent = 'Signing...';

            // 1. Get Presigned URL
            var customerId = document.getElementById('customer_id') ? document.getElementById('customer_id').value : null;

            fetch("{{ url_for('main.sign_s3') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    filename: file.name,
                    file_type: file.type || 'application/octet-stream',
                    folder: 'misc', // Fallback, override by backend if customer_id present
                    customer_id: customerId
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.error) throw new Error(data.error);

                    // 2. Upload
                    statusText.textContent = 'Uploading...';
                    var formData = new FormData();
                    for (var key in data.fields) {
                        formData.append(key, data.fields[key]);
                    }
                    formData.append('file', file);

                    var xhr = new XMLHttpRequest();
                    xhr.open('POST', data.url);

                    xhr.upload.onprogress = function (e) {
                        if (e.lengthComputable) {
                            var percent = Math.round((e.loaded / e.total) * 100);
                            progressBar.style.width = percent + '%';
                        }
                    };

                    xhr.onload = function () {
                        if (xhr.status === 204 || xhr.status === 200) {
                            statusText.textContent = 'Done';
                            statusText.classList.add('text-success');
                            statusText.classList.remove('text-muted');
                            progressBar.classList.add('bg-success');
                            progressBar.classList.remove('bg-primary');

                            // Add to global list
                            uploadedFiles.push({
                                key: data.fields.key,
                                filename: file.name,
                                file_type: 'other'
                            });
                            updateBidFilesJson();
                        } else {
                            statusText.textContent = 'Failed';
                            statusText.classList.add('text-danger');
                            progressBar.classList.add('bg-danger');
                        }
                    };

                    xhr.onerror = function () {
                        statusText.textContent = 'Error';
                        statusText.classList.add('text-danger');
                    };

                    xhr.send(formData);
                })
                .catch(err => {
                    console.error(err);
                    statusText.textContent = 'Error';
                    statusText.classList.add('text-danger');
                });
        }
    })();

    function toggleFlexibleDate() {
        if (bidDateInput.value) {
            flexibleDateContainer.style.display = 'block';
        } else {
            flexibleDateContainer.style.display = 'none';
            flexibleDateCheckbox.checked = false; // Reset if hidden
        }
    }

    if (bidDateInput) {
        bidDateInput.addEventListener('change', toggleFlexibleDate);
        // Also listen for input event just in case
        bidDateInput.addEventListener('input', toggleFlexibleDate);
        toggleFlexibleDate(); // Run on load
    }
</script>
{% endblock %}