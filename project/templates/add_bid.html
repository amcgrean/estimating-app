{% extends "base.html" %}

{% block title %}Add New Bid{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h2 class="display-5 font-weight-bold" style="font-family: 'Outfit', sans-serif;">Add New Bid</h2>
        <p class="text-muted small">Enter the details below to log a new bid request.</p>
    </div>
    <div class="col-md-4 text-right">
        <a href="{{ url_for('main.index') }}" class="btn btn-outline-secondary px-4 font-weight-600"
            style="border-radius: var(--radius-md);">
            <i class="fas fa-arrow-left mr-2"></i> Back to Dashboard
        </a>
    </div>
</div>

<div class="premium-card shadow-lg border-0" style="border-radius: var(--radius-lg);">
    <form action="{{ url_for('main.add_bid') }}" method="POST" enctype="multipart/form-data" class="p-2">
        {{ form.hidden_tag() }}

        <!-- Display Flash Messages explicitly if not caught by base template -->
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="alert alert-{{ category }}">{{ message }}</div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        <!-- Display Form Errors -->
        {% if form.errors %}
        <div class="alert alert-danger">
            Whoops! There were some errors with your submission:
            <ul>
                {% for field, errors in form.errors.items() %}
                {% for error in errors %}
                <li>{{ form[field].label.text if form[field].label else field }}: {{ error }}</li>
                {% endfor %}
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <div class="row">
            <!-- Left Column: Classification & Assignment -->
            <div class="col-lg-6 pr-lg-4 border-right">
                <h5 class="mb-4 text-primary d-flex align-items-center" style="font-size: 1rem; letter-spacing: 0.5px;">
                    <i class="fas fa-tags mr-2 small"></i> BASIC INFORMATION
                </h5>

                <div class="form-group mb-4">
                    <label class="font-weight-600 small text-uppercase tracking-wider mb-2">{{
                        form.project_name.label.text }}</label>
                    {{ form.project_name(class="input-modern", placeholder="e.g. Smith Residence - Framing") }}
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group mb-4">
                            <label class="font-weight-600 small text-uppercase tracking-wider mb-2">{{
                                form.plan_type.label.text }}</label>
                            {{ form.plan_type(class="input-modern") }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <!-- Status is typically Incomplete for new bids; hiding to simplify form -->
                        <div class="form-group mb-4" style="display: none;">
                            <label class="font-weight-600 small text-uppercase tracking-wider mb-2">{{
                                form.status.label.text }}</label>
                            {{ form.status(class="input-modern") }}
                        </div>
                    </div>
                </div>

                <div class="form-group mb-4">
                    <label class="font-weight-600 small text-uppercase tracking-wider mb-2">{{ form.branch_id.label.text
                        }}</label>
                    {{ form.branch_id(class="input-modern") }}
                </div>

                <!-- File Uploads -->
                <h5 class="mb-3 mt-4 text-primary d-flex align-items-center"
                    style="font-size: 1rem; letter-spacing: 0.5px;">
                    <i class="fas fa-paperclip mr-2 small"></i> ATTACHMENTS
                </h5>
                <div class="p-3 bg-light rounded border mb-4">
                    <div class="form-group mb-3">
                        <label class="font-weight-600 small text-uppercase tracking-wider mb-1">{{
                            form.plan_file.label.text }}</label>
                        {{ form.plan_file(class="form-control-file", id="file_plan") }}
                        {{ form.plan_key(id="plan_key") }}
                        <small class="form-text text-muted">Upload architectural plans (PDF only)</small>

                        <!-- Progress Bar for Plan -->
                        <div id="progress-container-plan" class="progress mt-2 d-none" style="height: 10px;">
                            <div id="progress-bar-plan"
                                class="progress-bar bg-success progress-bar-striped progress-bar-animated"
                                role="progressbar" style="width: 0%"></div>
                        </div>
                        <small id="status-plan" class="text-success font-weight-bold d-none mt-1"></small>
                    </div>

                    <div class="form-group mb-0">
                        <label class="font-weight-600 small text-uppercase tracking-wider mb-1">{{
                            form.email_file.label.text }}</label>
                        {{ form.email_file(class="form-control-file", id="file_email") }}
                        {{ form.email_key(id="email_key") }}
                        <small class="form-text text-muted">Upload request email or other docs</small>

                        <!-- Progress Bar for Email -->
                        <div id="progress-container-email" class="progress mt-2 d-none" style="height: 10px;">
                            <div id="progress-bar-email"
                                class="progress-bar bg-success progress-bar-striped progress-bar-animated"
                                role="progressbar" style="width: 0%"></div>
                        </div>
                        <small id="status-email" class="text-success font-weight-bold d-none mt-1"></small>
                    </div>
                </div>
            </div>

            <!-- Right Column: Details & Dates -->
            <div class="col-lg-6 pl-lg-4">
                <h5 class="mb-4 text-primary d-flex align-items-center" style="font-size: 1rem; letter-spacing: 0.5px;">
                    <i class="fas fa-user-tie mr-2 small"></i> CUSTOMER & TIMELINE
                </h5>

                <div class="form-group mb-4">
                    <label class="font-weight-600 small text-uppercase tracking-wider mb-2">{{
                        form.customer_id.label.text }}</label>
                    {{ form.customer_id(class="input-modern select2-enable") }}
                </div>

                <div class="form-group mb-4">
                    <label class="font-weight-600 small text-uppercase tracking-wider mb-2">{{
                        form.estimator_id.label.text }}</label>
                    {% if current_user.usertype.name == 'Sales Rep' %}
                    <!-- Sales Reps cannot assign estimators -->
                    <div class="form-control bg-light text-muted">No Estimator Assigned</div>
                    <div style="display:none;">{{ form.estimator_id(class="input-modern") }}</div>
                    {% else %}
                    {{ form.estimator_id(class="input-modern") }}
                    {% endif %}
                </div>

                <div class="form-group mb-4">
                    {% if current_user.usertype.name == 'Sales Rep' %}
                    <!-- Sales Reps create bids for themselves automatically -->
                    <input type="hidden" name="sales_rep_id" value="{{ current_user.sales_rep_id }}">
                    {% else %}
                    <!-- Estimators/Admins assign a Sales Rep -->
                    <label class="font-weight-600 small text-uppercase tracking-wider mb-2">{{
                        form.sales_rep_id.label.text }}</label>
                    {{ form.sales_rep_id(class="input-modern") }}
                    {% endif %}
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group mb-4">
                            <label class="font-weight-600 small text-uppercase tracking-wider mb-2">{{
                                form.bid_date.label.text }} <span
                                    class="text-muted font-weight-normal">(Optional)</span></label>
                            {{ form.bid_date(class="input-modern", type="date") }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group mb-4">
                            <label class="font-weight-600 small text-uppercase tracking-wider mb-2">{{
                                form.due_date.label.text }}</label>
                            {{ form.due_date(class="input-modern", type="date") }}
                        </div>
                    </div>
                </div>

                <!-- Flexible Bid Date Toggle - Visible only when Bid Date is set -->
                <div class="form-group mb-4" id="flexible-date-container" style="display: none;">
                    <div class="custom-control custom-checkbox">
                        {{ form.flexible_bid_date(class="custom-control-input", id="flexibleBidDate") }}
                        <label class="custom-control-label font-weight-600 text-muted" for="flexibleBidDate">
                            {{ form.flexible_bid_date.label.text }}
                        </label>
                    </div>
                </div>

                <!-- Specs Toggle -->
                <div class="form-group mt-2">
                    <div class="custom-control custom-switch">
                        {{ form.include_specs(class="custom-control-input", id="includeSpecsToggle") }}
                        <label class="custom-control-label font-weight-bold ml-2 pt-1" for="includeSpecsToggle">Include
                            Detailed Specifications</label>
                    </div>
                    <small class="form-text text-muted ml-5">Enable to add specific notes for Framing, Siding,
                        etc.</small>
                </div>
            </div>

            <div class="col-12 mt-3 pt-3 border-top" id="specs-section" style="display: none;">
                <h5 class="mb-4 text-primary d-flex align-items-center" style="font-size: 1rem; letter-spacing: 0.5px;">
                    <i class="fas fa-list-alt mr-2 small"></i> MODULE SPECIFICATIONS
                </h5>

                <!-- Grid Layout for Specs (No Tabs) -->
                <div class="row">
                    <!-- Column 1: Structurals & Deck -->
                    <div class="col-lg-6">
                        <!-- Framing Card -->
                        <div class="card mb-4 shadow-sm">
                            <div class="card-header bg-light py-2">
                                <h6 class="mb-0 text-primary font-weight-bold"><i class="fas fa-hammer mr-2"></i>
                                    Framing</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    {% for field in form.framing %}
                                    {% if field.type == 'CSRFTokenField' or field.type == 'HiddenField' %}
                                    {{ field() }}
                                    {% elif field.type != 'CSRFTokenField' and field.type != 'HiddenField' %}
                                    <div class="col-md-6 mb-3">
                                        <label class="font-weight-600 small text-uppercase text-muted mb-1">{{
                                            field.label.text }}</label>
                                        {{ field(class="form-control form-control-sm") }}
                                    </div>
                                    {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <!-- Deck Card -->
                        <div class="card mb-4 shadow-sm">
                            <div class="card-header bg-light py-2">
                                <h6 class="mb-0 text-success font-weight-bold"><i class="fas fa-umbrella mr-2"></i> Deck
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    {% for field in form.deck %}
                                    {% if field.type == 'CSRFTokenField' or field.type == 'HiddenField' %}
                                    {{ field() }}
                                    {% elif field.type != 'CSRFTokenField' and field.type != 'HiddenField' %}
                                    <div class="col-md-6 mb-3">
                                        <label class="font-weight-600 small text-uppercase text-muted mb-1">{{
                                            field.label.text }}</label>
                                        {{ field(class="form-control form-control-sm") }}
                                    </div>
                                    {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Column 2: Exterior Handling -->
                    <div class="col-lg-6">
                        <!-- Siding Card -->
                        <div class="card mb-4 shadow-sm">
                            <div class="card-header bg-light py-2">
                                <h6 class="mb-0 text-info font-weight-bold"><i class="fas fa-layer-group mr-2"></i>
                                    Siding</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    {% for field in form.siding %}
                                    {% if field.type == 'CSRFTokenField' or field.type == 'HiddenField' %}
                                    {{ field() }}
                                    {% elif field.type != 'CSRFTokenField' and field.type != 'HiddenField' %}
                                    <div class="col-md-6 mb-3">
                                        <label class="font-weight-600 small text-uppercase text-muted mb-1">{{
                                            field.label.text }}</label>
                                        {{ field(class="form-control form-control-sm") }}
                                    </div>
                                    {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <!-- Trim Card -->
                        <div class="card mb-4 shadow-sm">
                            <div class="card-header bg-light py-2">
                                <h6 class="mb-0 text-warning font-weight-bold"><i
                                        class="fas fa-ruler-combined mr-2"></i> Trim</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    {% for field in form.trim %}
                                    {% if field.type == 'CSRFTokenField' or field.type == 'HiddenField' %}
                                    {{ field() }}
                                    {% elif field.type != 'CSRFTokenField' and field.type != 'HiddenField' %}
                                    <div class="col-md-6 mb-3">
                                        <label class="font-weight-600 small text-uppercase text-muted mb-1">{{
                                            field.label.text }}</label>
                                        {{ field(class="form-control form-control-sm") }}
                                    </div>
                                    {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Row 2: Windows, Doors, Roof -->
                <div class="row">
                    <div class="col-lg-4">
                        <div class="card mb-4 shadow-sm">
                            <div class="card-header bg-light py-2">
                                <h6 class="mb-0 text-dark font-weight-bold"><i class="fas fa-window-maximize mr-2"></i>
                                    Windows</h6>
                            </div>
                            <div class="card-body">
                                {% for field in form.window %}
                                {% if field.type == 'CSRFTokenField' or field.type == 'HiddenField' %}
                                {{ field() }}
                                {% elif field.type != 'CSRFTokenField' and field.type != 'HiddenField' %}
                                <div class="form-group mb-2">
                                    <label class="font-weight-600 small text-uppercase text-muted mb-1">{{
                                        field.label.text }}</label>
                                    {{ field(class="form-control form-control-sm") }}
                                </div>
                                {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="card mb-4 shadow-sm">
                            <div class="card-header bg-light py-2">
                                <h6 class="mb-0 text-dark font-weight-bold"><i class="fas fa-door-open mr-2"></i> Doors
                                </h6>
                            </div>
                            <div class="card-body">
                                {% for field in form.door %}
                                {% if field.type == 'CSRFTokenField' or field.type == 'HiddenField' %}
                                {{ field() }}
                                {% elif field.type != 'CSRFTokenField' and field.type != 'HiddenField' %}
                                <div class="form-group mb-2">
                                    <label class="font-weight-600 small text-uppercase text-muted mb-1">{{
                                        field.label.text }}</label>
                                    {{ field(class="form-control form-control-sm") }}
                                </div>
                                {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="card mb-4 shadow-sm">
                            <div class="card-header bg-light py-2">
                                <h6 class="mb-0 text-secondary font-weight-bold"><i class="fas fa-home mr-2"></i>
                                    Shingle/Roof</h6>
                            </div>
                            <div class="card-body">
                                {% for field in form.shingle %}
                                {% if field.type == 'CSRFTokenField' or field.type == 'HiddenField' %}
                                {{ field() }}
                                {% elif field.type != 'CSRFTokenField' and field.type != 'HiddenField' %}
                                <div class="form-group mb-2">
                                    <label class="font-weight-600 small text-uppercase text-muted mb-1">{{
                                        field.label.text }}</label>
                                    {{ field(class="form-control form-control-sm") }}
                                </div>
                                {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- General Notes -->
            <div class="col-12 mt-4 pt-4 border-top">
                <div class="form-group mb-4">
                    <label class="font-weight-600 small text-uppercase tracking-wider mb-2">{{ form.notes.label.text
                        }}</label>
                    {{ form.notes(class="input-modern", rows="3", placeholder="Any additional project details...") }}
                </div>

                <div class="d-flex justify-content-end gap-3 mt-4">
                    <a href="{{ url_for('main.index') }}" class="btn btn-outline-secondary px-4 py-3">Cancel</a>
                    <button type="submit" class="btn-premium px-5 py-3">
                        <i class="fas fa-check-circle mr-2"></i> {{ form.submit.label.text }}
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.getElementById('branch_id').onchange = function () {
        var branchId = this.value;
        var url = new URL(window.location.href);
        url.searchParams.set('branch_id', branchId);
        window.location.href = url.toString();
    };

    // Customer -> Sales Rep Auto-Selection
    // Safe parsing of the map passed from backend
    var customerSalesReps = {{ customer_sales_rep_map| tojson | safe if customer_sales_rep_map else '{}' }};

    $('#customer_id').change(function () {
        var customerId = $(this).val();
        // Check if we have a mapped sales rep
        if (customerSalesReps.hasOwnProperty(customerId)) {
            var salesRepId = customerSalesReps[customerId];
            var salesRepSelect = $('#sales_rep_id');

            // Only update if the select exists (Estimator view) and the option exists
            if (salesRepSelect.length && salesRepSelect.find('option[value="' + salesRepId + '"]').length) {
                salesRepSelect.val(salesRepId).trigger('change');
            }
        }
    });

    // Toggle Specs Section
    const specsToggle = document.getElementById('includeSpecsToggle');
    const specsSection = document.getElementById('specs-section');

    function toggleSpecs() {
        if (specsToggle.checked) {
            specsSection.style.display = 'block';
            // Optional: Scroll to section
            // specsSection.scrollIntoView({ behavior: 'smooth' });
        } else {
            specsSection.style.display = 'none';
        }
    }

    if (specsToggle) {
        specsToggle.addEventListener('change', toggleSpecs);
        // Run on load in case of form validation failure (re-rendering)
        toggleSpecs();
    }

    // Toggle Flexible Bid Date
    const bidDateInput = document.getElementById('bid_date');
    const flexibleDateContainer = document.getElementById('flexible-date-container');
    const flexibleDateCheckbox = document.getElementById('flexibleBidDate');

    // --- S3 Direct Upload Logic ---
    (function () {
        function initS3Upload(fileId, keyId, progressId, barId, statusId, folder) {
            var fileInput = document.getElementById(fileId);
            var keyInput = document.getElementById(keyId);
            var progressContainer = document.getElementById(progressId);
            var progressBar = document.getElementById(barId);
            var statusText = document.getElementById(statusId);

            // Grab CSRF token from the form's hidden input
            var csrfInput = document.querySelector('input[name="csrf_token"]');
            var csrfToken = csrfInput ? csrfInput.value : '';

            if (!fileInput) return;

            fileInput.addEventListener('change', function () {
                var file = fileInput.files[0];
                if (!file) return;

                // Reset UI
                progressContainer.classList.remove('d-none');
                progressBar.style.width = '0%';
                progressBar.textContent = '0%';
                progressBar.classList.remove('bg-danger');
                progressBar.classList.add('bg-success');
                statusText.textContent = 'Preparing upload...';
                statusText.classList.remove('d-none', 'text-danger');
                statusText.classList.add('text-success');
                statusText.textContent = 'Signing upload...';

                // 1. Get Presigned URL
                fetch("{{ url_for('main.sign_s3') }}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        filename: file.name,
                        file_type: file.type || 'application/octet-stream',
                        folder: folder
                    })
                })
                    .then(response => {
                        if (!response.ok) throw new Error('Signing failed (' + response.status + ')');
                        return response.json();
                    })
                    .then(data => {
                        if (data.error) throw new Error(data.error);

                        // 2. Upload to S3
                        statusText.textContent = 'Uploading to S3...';
                        var formData = new FormData();
                        // Append fields in order
                        for (var key in data.fields) {
                            formData.append(key, data.fields[key]);
                        }
                        formData.append('file', file);

                        var xhr = new XMLHttpRequest();
                        xhr.open('POST', data.url);

                        xhr.upload.onprogress = function (e) {
                            if (e.lengthComputable) {
                                var percent = Math.round((e.loaded / e.total) * 100);
                                progressBar.style.width = percent + '%';
                                progressBar.textContent = percent + '%';
                            }
                        };

                        xhr.onload = function () {
                            if (xhr.status === 204 || xhr.status === 200) {
                                // Success
                                keyInput.value = data.fields.key; // Store key for backend
                                statusText.textContent = 'Upload Complete!';
                                progressBar.classList.remove('progress-bar-animated');

                                // IMPORTANT: Remove name attribute to prevent double upload to Flask
                                fileInput.removeAttribute('name');
                            } else {
                                statusText.textContent = 'Upload Failed!';
                                statusText.classList.add('text-danger');
                                progressBar.classList.add('bg-danger');
                                console.error('S3 Upload failed status: ' + xhr.status);
                            }
                        };

                        xhr.onerror = function () {
                            statusText.textContent = 'Network Error!';
                            statusText.classList.add('text-danger');
                            progressBar.classList.add('bg-danger');
                        };

                        xhr.send(formData);
                    })
                    .catch(error => {
                        console.error(error);
                        statusText.textContent = 'Error: ' + error.message;
                        statusText.classList.remove('text-success');
                        statusText.classList.add('text-danger');
                        progressBar.classList.remove('bg-success');
                        progressBar.classList.add('bg-danger');
                    });
            });
        }

        // Init uploads
        initS3Upload('file_plan', 'plan_key', 'progress-container-plan', 'progress-bar-plan', 'status-plan', 'plans');
        initS3Upload('file_email', 'email_key', 'progress-container-email', 'progress-bar-email', 'status-email', 'emails');
    })();

    function toggleFlexibleDate() {
        if (bidDateInput.value) {
            flexibleDateContainer.style.display = 'block';
        } else {
            flexibleDateContainer.style.display = 'none';
            flexibleDateCheckbox.checked = false; // Reset if hidden
        }
    }

    if (bidDateInput) {
        bidDateInput.addEventListener('change', toggleFlexibleDate);
        // Also listen for input event just in case
        bidDateInput.addEventListener('input', toggleFlexibleDate);
        toggleFlexibleDate(); // Run on load
    }
</script>
{% endblock %}